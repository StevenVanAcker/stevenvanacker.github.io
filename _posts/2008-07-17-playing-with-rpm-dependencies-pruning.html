---
layout: post
title: 'Playing with RPM dependencies: pruning the tree'
date: '2008-07-17T17:28:00.004+02:00'
author: Steven Van Acker
tags:
- English
- Fedora
- RPM
modified_time: '2008-07-24T14:46:41.196+02:00'
blogger_id: tag:blogger.com,1999:blog-5513234137363262204.post-4921829879904692642
blogger_orig_url: http://www.singularity.be/2008/07/playing-with-rpm-dependencies-pruning.html
---

<!-- StevensBlogSpotFilterThing<br />I've set up a Fedora 9 and stripped everything I don't need out of it. Now I would like to make a kickstart profile out of it. But instead of telling kickstart to install the (mandatory) basesystem and then removing all the packages I list, I want to tell it to not install ANYTHING, except the packages I tell it to (ie. the basesystem minus some crap).<br /><br />So, I took the list of packages that I had installed, generated a dependency tree of it (using the graph generator from the previous post) and then threw out all packages in the list that were going to be installed anyway because the are dependencies of other packages.<br /><br />This is the script I used:<br /><br />[PRE]<br />#!/usr/bin/perl<br /><br />$AllPackages = {};<br />$Requires = {};<br />$RequiredBy = {};<br /><br />sub parseGeneratedDOTFile {<br />    my ($filename) = @_;<br /><br />    open IN, "$filename";<br />    while(my $line = &lt;IN&gt;) {<br />        if($line =~ /^"([^"]+)" -> "([^"]+)";$/) {<br />     $AllPackages->{$1} = 1;<br />     $AllPackages->{$2} = 1;<br />     $Requires->{$1}->{$2} = 1;<br />     $RequiredBy->{$2}->{$1} = 1;<br /> }<br />    }<br />    close IN;<br />}<br /><br /># requires(a,b) -> does a require b ?<br />sub requires {<br />    my ($a, $b) = @_;<br />    return $Requires->{$a}->{$b};<br />}<br /><br /># isRequiredBy(a,b) -> is a required by b ? (b requires a)<br />sub requires {<br />    my ($a, $b) = @_;<br />    return $RequiredBy->{$a}->{$b};<br />}<br /><br />sub getAllDependenciesRecursively {<br />    my (@list) = @_;<br /><br />    my $newlist = {};<br /><br />    foreach my $i (@list) {<br />        $newlist->{$i} = 1;<br /> foreach my $dep (keys %{$Requires->{$i}}) {<br />     $newlist->{$dep} = 1;<br /> }<br />    }<br /><br />    my @output = keys %$newlist;<br /><br />    if(scalar(@output) > scalar(@list)) {<br />        # something in the list changed, recurse more<br /> return getAllDependenciesRecursively(@output);<br />    } else {<br />        return @output;<br />    }<br />}<br /><br />sub getMinimalSetToInstall {<br />    my (@list) = @_;<br />    my %bla = map { $_ => 1 } @list;<br />    my $old = \%bla;<br />    my $new = {};<br /><br />    foreach my $pkg (@list) {<br />     my @revdeps = keys %{$RequiredBy->{$pkg}};<br />        if(scalar(@revdeps) != 0) {<br />     my $toBeAdded = 1;<br />     # this package is required by some packages<br />     # check if any of those packages is in the list we need to check<br />     foreach my $d (@revdeps) {<br />         if($old->{$d} == 1) {<br />      $toBeAdded = 0;<br />  }<br />     }<br /><br />     if($toBeAdded == 1) {<br />         $new->{$pkg} = 1;<br />     }<br /> } else {<br />     # This package isn't required by anything else, so just keep it in the list<br />     $new->{$pkg} = 1;<br /> }<br />    }<br /><br />    return keys %{$new}<br />}<br /><br />parseGeneratedDOTFile($ARGV[0]);<br /><br />@origlist = keys %{$AllPackages};<br />@smalllist = getMinimalSetToInstall(@origlist);<br />@generatedlist = getAllDependenciesRecursively((@smalllist));<br /><br />if(scalar(@origlist) == scalar(@generatedlist)) {<br />    print "Succesfully expanded minimal list into full list!\n\n";<br />    print "Original list (".scalar(@origlist)." packages):\n";<br />    print join " ", @origlist;<br />    print "\n\n";<br />    print "Condensed list (".scalar(@smalllist)." packages):\n";<br />    print join " ", @smalllist;<br />    print "\n";<br />}<br />[/PRE]<br /><br />This is the result so far (I haven't taken a detailed look at this output yet):<br /><br />[PRE]<br />Succesfully expanded minimal list into full list!<br /><br />Original list (196 packages):<br />glibc pciutils which iproute kudzu file rsyslog libattr libdhcp rpm less crontabs libsysfs nc sysvinit-tools dmraid hesiod checkpolicy system-config-firewall-tui findutils dbus-glib mkinitrd libidn tcpdump pth newt coreutils selinux-policy libpcap libselinux pygpgme grub libselinux-python time krb5-libs audit-libs newt-python pinentry kernel cyrus-sasl-plain gpgme anacron readline audit-libs-python iputils cracklib-dicts upstart hwdata man chkconfig initscripts gnupg2 glib2 procps file-libs gawk fedora-release-notes cyrus-sasl-lib psmisc nash mdadm libdhcp6client grep policycoreutils bash zlib bind-libs yum-metadata-parser setuptool ncurses-base libxml2 dbus dhcpv6-client zip slang hdparm shadow-utils pam tzdata tar kpartx python-urlgrabber db4 rpm-libs libvolume_id groff dhclient ncurses rpm-python bind-utils parted fedora-logos bc openssh-clients python-libs wireless-tools libcap pkgconfig make logrotate libsepol pcre dbus-python yum acpid bzip2 filesystem util-linux-ng dirmngr libsemanage tree unzip tcp_wrappers-libs cracklib openssl python-iniparse elfutils-libelf device-mapper libacl basesystem net-tools acl ncurses-libs isomd5sum openssh keyutils-libs wget usermode sudo libuser glibc-common udev selinux-policy-targeted symlinks libedit attr sed rhpl nss_db MAKEDEV iptables-ipv6 cyrus-sasl info python traceroute passwd libgcrypt setup system-config-network-tui popt eject ntfs-3g gdbm openssh-server diffutils vim-minimal device-mapper-libs libcurl gamin expat device-mapper-multipath rng-utils libstdc++ dbus-libs gzip procmail sendmail nspr mingetty iptables libnl libksba openldap libgcc linux-atm-libs lvm2 bzip2-libs kbd sqlite e2fsprogs libdhcp4client yum-utils at ethtool libusb ustr nss e2fsprogs-libs gpm authconfig cronie libgpg-error fedora-release module-init-tools ConsoleKit-libs cpio<br /><br />Condensed list (42 packages):<br />tree unzip which eject file ntfs-3g openssh-server device-mapper-multipath rng-utils nc sendmail acl system-config-firewall-tui setuptool tcpdump dhcpv6-client zip hdparm wget sudo kbd grub selinux-policy-targeted time dhclient symlinks attr bind-utils kernel nss_db at yum-utils cyrus-sasl-plain anacron bc openssh-clients gpm traceroute authconfig cronie man acpid<br />[/PRE]<br /><br /><br />StevensBlogSpotFilterThing --><br />I've set up a Fedora 9 and stripped everything I don't need out of it. Now I would like to make a kickstart profile out of it. But instead of telling kickstart to install the (mandatory) basesystem and then removing all the packages I list, I want to tell it to not install ANYTHING, except the packages I tell it to (ie. the basesystem minus some crap).<br /><br />So, I took the list of packages that I had installed, generated a dependency tree of it (using the graph generator from the previous post) and then threw out all packages in the list that were going to be installed anyway because the are dependencies of other packages.<br /><br />This is the script I used:<br /><br /><pre style="background-color: #EEEEEE; border: black 1px dashed; line-height: 100%; padding: 10px;"><br />#!/usr/bin/perl<br /><br />$AllPackages = {};<br />$Requires = {};<br />$RequiredBy = {};<br /><br />sub parseGeneratedDOTFile {<br />    my ($filename) = @_;<br /><br />    open IN, "$filename";<br />    while(my $line = &lt;IN&gt;) {<br />        if($line =~ /^"([^"]+)" -> "([^"]+)";$/) {<br />     $AllPackages->{$1} = 1;<br />     $AllPackages->{$2} = 1;<br />     $Requires->{$1}->{$2} = 1;<br />     $RequiredBy->{$2}->{$1} = 1;<br /> }<br />    }<br />    close IN;<br />}<br /><br /># requires(a,b) -> does a require b ?<br />sub requires {<br />    my ($a, $b) = @_;<br />    return $Requires->{$a}->{$b};<br />}<br /><br /># isRequiredBy(a,b) -> is a required by b ? (b requires a)<br />sub requires {<br />    my ($a, $b) = @_;<br />    return $RequiredBy->{$a}->{$b};<br />}<br /><br />sub getAllDependenciesRecursively {<br />    my (@list) = @_;<br /><br />    my $newlist = {};<br /><br />    foreach my $i (@list) {<br />        $newlist->{$i} = 1;<br /> foreach my $dep (keys %{$Requires->{$i}}) {<br />     $newlist->{$dep} = 1;<br /> }<br />    }<br /><br />    my @output = keys %$newlist;<br /><br />    if(scalar(@output) > scalar(@list)) {<br />        # something in the list changed, recurse more<br /> return getAllDependenciesRecursively(@output);<br />    } else {<br />        return @output;<br />    }<br />}<br /><br />sub getMinimalSetToInstall {<br />    my (@list) = @_;<br />    my %bla = map { $_ => 1 } @list;<br />    my $old = \%bla;<br />    my $new = {};<br /><br />    foreach my $pkg (@list) {<br />     my @revdeps = keys %{$RequiredBy->{$pkg}};<br />        if(scalar(@revdeps) != 0) {<br />     my $toBeAdded = 1;<br />     # this package is required by some packages<br />     # check if any of those packages is in the list we need to check<br />     foreach my $d (@revdeps) {<br />         if($old->{$d} == 1) {<br />      $toBeAdded = 0;<br />  }<br />     }<br /><br />     if($toBeAdded == 1) {<br />         $new->{$pkg} = 1;<br />     }<br /> } else {<br />     # This package isn't required by anything else, so just keep it in the list<br />     $new->{$pkg} = 1;<br /> }<br />    }<br /><br />    return keys %{$new}<br />}<br /><br />parseGeneratedDOTFile($ARGV[0]);<br /><br />@origlist = keys %{$AllPackages};<br />@smalllist = getMinimalSetToInstall(@origlist);<br />@generatedlist = getAllDependenciesRecursively((@smalllist));<br /><br />if(scalar(@origlist) == scalar(@generatedlist)) {<br />    print "Succesfully expanded minimal list into full list!\n\n";<br />    print "Original list (".scalar(@origlist)." packages):\n";<br />    print join " ", @origlist;<br />    print "\n\n";<br />    print "Condensed list (".scalar(@smalllist)." packages):\n";<br />    print join " ", @smalllist;<br />    print "\n";<br />}<br /></pre><br /><br />This is the result so far (I haven't taken a detailed look at this output yet):<br /><br /><pre style="background-color: #EEEEEE; border: black 1px dashed; line-height: 100%; padding: 10px;"><br />Succesfully expanded minimal list into full list!<br /><br />Original list (196 packages):<br />glibc pciutils which iproute kudzu file rsyslog libattr libdhcp rpm less crontabs libsysfs nc sysvinit-tools dmraid hesiod checkpolicy system-config-firewall-tui findutils dbus-glib mkinitrd libidn tcpdump pth newt coreutils selinux-policy libpcap libselinux pygpgme grub libselinux-python time krb5-libs audit-libs newt-python pinentry kernel cyrus-sasl-plain gpgme anacron readline audit-libs-python iputils cracklib-dicts upstart hwdata man chkconfig initscripts gnupg2 glib2 procps file-libs gawk fedora-release-notes cyrus-sasl-lib psmisc nash mdadm libdhcp6client grep policycoreutils bash zlib bind-libs yum-metadata-parser setuptool ncurses-base libxml2 dbus dhcpv6-client zip slang hdparm shadow-utils pam tzdata tar kpartx python-urlgrabber db4 rpm-libs libvolume_id groff dhclient ncurses rpm-python bind-utils parted fedora-logos bc openssh-clients python-libs wireless-tools libcap pkgconfig make logrotate libsepol pcre dbus-python yum acpid bzip2 filesystem util-linux-ng dirmngr libsemanage tree unzip tcp_wrappers-libs cracklib openssl python-iniparse elfutils-libelf device-mapper libacl basesystem net-tools acl ncurses-libs isomd5sum openssh keyutils-libs wget usermode sudo libuser glibc-common udev selinux-policy-targeted symlinks libedit attr sed rhpl nss_db MAKEDEV iptables-ipv6 cyrus-sasl info python traceroute passwd libgcrypt setup system-config-network-tui popt eject ntfs-3g gdbm openssh-server diffutils vim-minimal device-mapper-libs libcurl gamin expat device-mapper-multipath rng-utils libstdc++ dbus-libs gzip procmail sendmail nspr mingetty iptables libnl libksba openldap libgcc linux-atm-libs lvm2 bzip2-libs kbd sqlite e2fsprogs libdhcp4client yum-utils at ethtool libusb ustr nss e2fsprogs-libs gpm authconfig cronie libgpg-error fedora-release module-init-tools ConsoleKit-libs cpio<br /><br />Condensed list (42 packages):<br />tree unzip which eject file ntfs-3g openssh-server device-mapper-multipath rng-utils nc sendmail acl system-config-firewall-tui setuptool tcpdump dhcpv6-client zip hdparm wget sudo kbd grub selinux-policy-targeted time dhclient symlinks attr bind-utils kernel nss_db at yum-utils cyrus-sasl-plain anacron bc openssh-clients gpm traceroute authconfig cronie man acpid<br /></pre>