---
layout: post
title: bridged networking with Virtualbox
date: '2007-09-09T10:28:00.000+02:00'
author: Steven Van Acker
tags: 
modified_time: '2008-01-21T10:29:14.241+01:00'
blogger_id: tag:blogger.com,1999:blog-5513234137363262204.post-7138043678561079824
blogger_orig_url: http://www.singularity.be/2007/09/bridged-networking-with-virtualbox.html
---

<a href="http://www.virtualbox.org">Virtualbox</a> is a great tool. It looks a lot like VMWare, and has a lot of it's functionality. It seems to runs faster and it's opensource AND it has ubuntu packages.<br /><br />But virtualbox's networksetup sucks. Like VMWare, it allows for network-connections from the guest OS through NAT, which works nicely. But for most of my applications, I need bridged networking between the guest OS and the network adapter of the host OS.<br /><br />Several guides exist on the internet that explain in detail how to do each step. But none of them explain the big red lines.<br /><br />As I found out, it's pretty simple:<br /><ul><br /><li>Create a TAP/TUN device</li><br /><li>Create a bridge between a physical interface (like eth0) and the TAP/TUN device</li><br /><li>Bring all interfaces up</li><br /></ul><br /><br />OK, that's it ! See ? It's not difficult at all.<br /><br />But there is trickery involved to be able to keep using the physical device together with virtualbox. Once you setup the bridge, you will not be able to use the physical device anymore and network connectvity will be lost.<br /><br />Instead of setting an IP address on the physical interface (be it either with DHCP or static), you now need to set this IP on the bridge.<br /><br />To me this all sounds ugly. I use Ubuntu, and I don't want to mess with the networksettings this much because I expect NetworkManager to do that. The solution is to trick NetworkManager into thinking that nothing has changed. And to do that, we pull an old switcheroo on the network devices.<br /><br /><img src="/gallery2/main.php?g2_view=core.DownloadItem&g2_itemId=12386"><br /><br />NetworkManager expects eth0 (in my case) to be the interface it needs to configure. But when using Virtualbox, I need to create a bridge (br0) and tell NetworkManager to use that interface instead. I have no idea how NetworkManager works, but I assume it just looks at the devicename. So before NetworkManager starts, I rename eth0 to something else (old-eth0) and createn a bridge called eth0.<br /><br /><img src="/gallery2/main.php?g2_view=core.DownloadItem&g2_itemId=12391"><br /><br />This setup works greatly. When I reboot, all devices are set up nicely and I can start Virtualbox and use bridged networkinng. But there is still a problem: NetworkManager is very confused.<br /><br />I'll look into that later on<br /><br />This is the script I use to create tap1 and tap2<br />It should be made executable and linked into the subdirectories of /etc/network (if-down.d, if-post-down.d, if-pre-up.d and if-up.d)<br /><br />Don't give the script an extension like "virtualbox.sh", because it apparently doesn't work that way.<br /><br /><pre><br />#!/bin/bash<br /><br />TAPS="tap1 tap2"<br />MYINTERFACES="eth0"<br /><br />if [ "$IFACE" != "$MYINTERFACES" ];<br />then<br />    exit;<br />fi<br /><br /><br /><br />pre_down() {<br />    # first, remove all setup<br />    for INT in $TAPS; do<br />        echo "# switching off $INT"<br />        ifconfig $INT down<br />        echo "# removing $INT from bridge"<br />        brctl delif $IFACE $INT<br />        echo "# removing $INT alltogether"<br />        tunctl -d $INT<br />    done<br />}<br /><br />post_down() {<br />    echo "# bringing down the physical interface"<br />    ifconfig old-$IFACE down<br />    echo "# removing the physical interface from the bridge"<br />    brctl delif $IFACE old-$IFACE<br />    echo "# deleting the bridge $IFACE"<br />    brctl delbr $IFACE<br />    echo "# renaming the physical interface old-$IFACE back to $IFACE"<br />    ip link set old-$IFACE name $IFACE<br />}<br /><br />pre_up() {<br />    echo "# renaming $IFACE to old-$IFACE"<br />    ip link set $IFACE name old-$IFACE<br />    echo "# setting up $IFACE to be a bridge"<br />    brctl addbr $IFACE<br />    echo "# adding old-$IFACE to the bridge $IFACE"<br />    brctl addif $IFACE old-$IFACE<br />    echo "# bringing up the physical interface"<br />    ifconfig old-$IFACE up<br />}<br /><br />post_up() {<br />    # setting up the tun devices<br />    for INT in $TAPS; do<br />        echo "# creating $INT"<br />        tunctl -t $INT -u deepstar<br />    done<br />    <br />    chown root.vboxusers /dev/net/tun<br />    <br />    for INT in $TAPS; do<br />        echo "# adding $INT to bridge"<br />        brctl addif $IFACE $INT<br />        echo "# switching on $INT"<br />        ifconfig $INT up<br />    done<br />}<br /><br /><br />case $PHASE in <br />    pre-up)<br />        pre_up<br />        ;;<br />    post-down)<br />        post_down<br />        ;;<br />    post-up)<br />        post_up<br />        ;;<br />    pre-down)<br />        pre_down<br />        ;;<br />esac<br /></pre>