---
layout: post
title: 'new desktop: phase 2 - versioned backup'
date: '2007-03-29T22:40:00.000+02:00'
author: Steven Van Acker
tags: 
modified_time: '2008-01-18T10:44:14.789+01:00'
blogger_id: tag:blogger.com,1999:blog-5513234137363262204.post-8810673424504241435
blogger_orig_url: http://www.singularity.be/2007/03/new-desktop-phase-2-versioned-backup.html
---

I've been looking at several ways of doing versioned backup these last couple days. Remember, I want to put entire directories under automatic version-control so that all changes to files in those directories are recorded. Then I want to have a copy of this data on my server, which should sync automatically also.<br /><br />There is <a href='http://wayback.sourceforge.net/'>WayBack</a>, which describes itself as "User-level Versioning File System for Linux". The nice thing about this, is that it's based on FUSE (userspace filesystem). The sad thing is that it's no longer maintained :(<br /><br />I couldn't find anything to fit my purpose, so I guess I'll have to build my own, using prebuilt components.<br /><br />I basically want to have a local versioning system (fully inside my encrypted homedirectory) and sync that to my server from time to time.<br /><br />There are a couple of versioning systems around. The most famous is no doubt <a href='http://subversion.tigris.org/'>Subversion</a>. Then there is <a href='http://www.nongnu.org/cvs/'>CVS</a>, which is a predecessor of Subversion. CVS works on files instead of directories. There is also <a href='http://svk.bestpractical.com/view/HomePage'>SVK</a>, which is built on top of Subversion. It's advantage over Subversion (SVN) is that it doesn't have .svn directories all over the place which pollute filesystems. But it's documentation leaves alot to be desired...<br /><a href='http://www.gnu.org/software/rcs/rcs.html'>RCS</a> should also be mentioned, because it's great to do versioning on files without having to do complicated networked setups. RCS just works locally and does a very good job.<br /><br />On top of that, there are also: <a href='http://bazaar-vcs.org/'>BZR (bazaar-ng)</a> which claims to be able to track renamed files and directories, Cogito, CVSNT, MCVS, Mercurial, Monotone and PRCS. <br /><br />Besides the first 4, none of those ring a bell.<br /><br />At this particular instant, I'm looking at Bazaar-ng and I'm impressed by passages like this:<br /><pre><br />We believe that the revision control system should not impose <br />arbitrary restrictions on your project. In other words, your <br />community should be able to treat your tree as entirely malleable, <br />reshaping it to improve clarity and structure of the code layout as <br />much as the contents of the files that make up the tree.<br /></pre><br /><br />That's how I like things :) I don't want a system to impose limits on me. If the system can't cope with my odd and insane behaviour, then I need something else.<br /><br />Also<br /><pre><br />Bazaar is a free software project with a large community of <br />contributors, sponsored by Canonical Limited, the founders of Ubuntu <br />and Launchpad.<br /></pre><br /><br />If Canonical supports it, then I'm sure it will integrate well with Ubuntu.<br /><br />[A quick test later]<br />I'm very impressed with bzr. It's usage is so simple, and it allows me to automatically track all new files in a directory so it will be easy to do auto-checkin.<br /><br />Apparently, I can just rsync the entire working copy to a server, and things will just work. The bzr people advise to use bzr push though, which is fine by me :)<br /><br />I'll be working on a script to automatically commit my changes. More on this later.<br /><br />[Some tests later]<br /><br />My current setup looks like this: on the local machine I have a file called .bzr-dirlist, which contains a list of directories under revision control (like Documents and Projects).<br /><br />The script then looks like this:<br /><pre><br />#!/bin/bash<br /><br />dirlist=$HOME/.bzr-dirlist<br /><br />cd $HOME<br /><br />for dir in `cat $dirlist`;<br />do<br />        bzr add $dir<br />done<br /><br />bzr commit --message "Auto-commit `whoami`@`hostname` on `date`"<br /><br /></pre><br /><br />This script will examine the new files in the directories and commit them to bzr.<br /><br />Next, I need to mirror these directories to a remote server.<br />Just using push isn't enough because that won't "checkout" the files.<br />There is a plugin that does a push and an update, called <a href='https://launchpad.net/bzr-push-and-update/'>"push-and-update"</a><br /><br />I can install it by doing:<br /><pre><br />guest@deepstar-desktop:~/.bazaar$ mkdir plugins<br />guest@deepstar-desktop:~/.bazaar$ cd plugins/<br />guest@deepstar-desktop:~/.bazaar/plugins$ <br />guest@deepstar-desktop:~/.bazaar/plugins$ bzr branch https://launchpad.net/bzr-push-and-update push_and_update<br /></pre><br /><br />The plugin even provides hooks for bash_completion, which is a plus for me :)<br /><br />This command will push and update the files:<br /><pre><br />guest@deepstar-desktop:~$ bzr push-and-update sftp://guestbackup@localhost/home/guestbackup/something<br /></pre><br /><br />But before doing that, the directory must be created and initialised on the remote server (with bzr init)<br /><br />I'll have to use SSH-keys to do all this without entering a password...<br /><br />[later]<br />The bazaar-ng developers also suggest putting this line in /etc/apt/sources.list to get the latest bzr packages:<br /><pre><br />deb http://bazaar-vcs.org/releases/debs/edgy ./<br /></pre><br />