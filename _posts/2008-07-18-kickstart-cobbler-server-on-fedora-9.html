---
layout: post
title: Kickstart a cobbler server on Fedora 9 (and create offspring)
date: '2008-07-18T21:51:00.017+02:00'
author: Steven Van Acker
tags:
- English
- Cobbler
- Fedora
- Kickstart
modified_time: '2008-07-24T14:45:55.086+02:00'
blogger_id: tag:blogger.com,1999:blog-5513234137363262204.post-7238324172304800323
blogger_orig_url: http://www.singularity.be/2008/07/kickstart-cobbler-server-on-fedora-9.html
---

<!-- StevensBlogSpotFilterThing<br /><h3>How many systems do you administer ?</h3><br /><p><br />If you've ever had to install more than a trivial amount of operating systems, you know how to appreciate good automated installation systems. Most (if not all) Linux distributions noticed this and started building automated installation systems. Debian has FAI and preseeding, Solaris has Jumpstart and Redhat has Kickstart. I must admit I took a stab at this problem myself by preseeding a Debian installation CD, but I've noticed that it takes too much of my time to rebuild the installation CD every time a new Debian release happens.<br /></p><br /><p><br />Lucky for me, Kickstart can supposedly be used to automate other linux installations. That's why I've been looking at Kickstart lately. And what can I say ? It works.<br /></p><br /><p><br />So here we go ! Imagine this: I need to install 500 servers, all with different configurations.<br />I create 500 kickstart files, each defining the setup of a single system. Then I... walk up to every of my 500 systems, put in a CD, boot it, tell it where the kickstart file is and let the thing install.<br /></p><br /><p>Allright, I can see some problems right there.</p><br /><ul><br /><li>First of all, I need to create 500 kickstart files, but that's nothing an army of welltrained monkeys with typewriters can't achieve.</li><br /><li>Second, I need to walk up to every machine and put a CD in, wait till it gets to the isolinux screen and then type in the extra "ks=http://example.com/uniquestringoeshere.ks" at the end of the command line.</li><br /><li>Third, this will approximately take forever. I either need to burn 500 CD's to boot from, or I need to wait for each installation to finish and then move the installation CD from one system to the next.</li><br /></ul><br /><br /><p><br />Man, administering systems is hard. In this light, it's a good thing I don't actually have to administer 500 systems. But the guys at Redhat probably do and they came up with their next great idea.<br /></p><br /><br /><br /><h3>Cobbler: Provisioning made easy</h3><br /><p><br />Almost 9 years ago, Intel invented the Preboot eXecution Environment (PXE), which allows eg diskless computers to boot over network without any user interaction. As part of the boot process, the BIOS might try several disks, CD-drives and floppydisk stations to try and boot, after which it can ask a networkcard to do the same. The networkcard will then try to locate a suitable server from which it can get data to boot up with.<br /></p><br /><p><br />Setting up a TFTP server to do this is not that difficult, but some other steps are involved that combine many small easy tasks into a very big time-consuming list of tasks. This is where cobbler comes in.<br /></p><br /><p><br />Cobbler is a provisioning infrastructure that takes care of all the underlying details and components for you. After installing and configuring cobbler, you basically tell it which CD you want to "publish" through PXE and it just happens. Clients booting through PXE will then get a nice menu where they can select what the want to boot. Even better, you can tell cobbler about a specific system in advance (by registering its MAC address for example) and then that system won't see a menu at all, it will just boot into whatever you specify.<br /></p><br /><small>giggity</small><br /><p>Right, let's look at how cobbler works</p><br /><br /><h3>Cobbler concepts</h3><br /><p><br />There are 3 concepts that pop up all the time and that I needed to understand. I will describe them here as I understand them, AT NO EXTRA COST. You can thank me later.<br /></p><br /><br /><dl><br /><dt>Distributions</dt><br /><dd>This is pretty much self explanatory. A distribution is a ... If I want to install a Centos 5 on a i386 somewhere, I need to make a "distribution" containing the Centos 5 DVD which I can name "Centos 5 i386"</dd><br /><dt>Profiles</dt><br /><dd>This is what you get when you pack a distribution together with a kickstart file. If I want to install a Centos 5 with an apache and SSH server on it, I make a kickstart file for it and glue it together with a "Centos 5" distribution and call that a "Centos 5 Webserver+SSH" profile.</dd><br /><dt>Systems</dt><br /><dd>Associating a certain physical system with a profile happens through a "System" specification. If I want to install my cute yellow 486 here under the table using the "Centos 5 Webserver+SSH" profile, I need to make a system specification by specifying the MAC-address, IP and hostname (tweety) I want for this server. Then I call this system "tweety"</dd><br /><dd><br /></dl><br /><br />[FULLIMG:http://data.singularity.be/images/full/undated/cobbler/cobbler.png]<br /><br />Here's a little scheme to show how these things fit together. You can have several distributions (in pinkish red), each of which can have several profiles associated with it (green), each of which can have several systems to it (yellow).<br /><br /><h3>Lab setup</h3><br /><br /><p><br />On to the practical side of cobbler. I'm going to setup a cobbler server on Fedora 9 and use that to install another system using Fedora 9 aswell. All of this will be done in Virtualbox.<br /></p><br /><br />[FULLIMG:http://data.singularity.be/images/full/undated/cobbler/cobbler_lab_setup.png]<br /><br /><p><br />The cobbler server will be named "vishnu" and it will have 2 networkcards: eth0 will be connected to an internet-connected network with DHCP on it. eth1 will be connected to a private network without any traffic on it (static IP). The private network has IP-range 172.16.1.0/24<br /></p><br /><br /><p><br />The machine to be installed using cobbler, has no name really. It has 1 networkcard connected to the private network and boots PXE.<br /></p><br /><br /><h3>Kickstarting the cobbler server: vishnu</h3><br /><p><br />Installing cobbler is fairly simple. Install the base operating system, then use yum to install cobbler, edit some configfiles and you're done. This doesn't include adding distributions or profiles though.<br /></p><br /><br /><p><br />But wait a minute. Do I really want to install vishnu manually ? Booting the CD and going through the installation process after which I have to login, install packages and edit configfiles ?<br />Of course not. This is exactly what kickstart was created for, so let's use it.<br /></p><br /><br /><p>This is the kickstart file I use for vishnu:</p><br />[PRE]<br />#version=F9<br />install<br />text<br />cdrom<br />lang en_US.UTF-8<br />keyboard us<br />timezone --utc Europe/Brussels<br /><br /><br /># network settings<br />network --device eth0 --bootproto dhcp --hostname vishnu<br />network --device eth1 --bootproto static --ip 172.16.1.1 --netmask 255.255.255.0<br /><br /># root account<br />authconfig --enableshadow --passalgo=sha512<br />rootpw  --iscrypted $1$6cEAJbnh$TdRTNKsAnwE/PYw3dk/o20<br /><br /># security<br />#firewall --enabled --ssh --dhcp --trust eth1<br />firewall --disabled<br />selinux --enforcing<br /><br /># partitioning and bootloader<br />clearpart --all<br />autopart <br />bootloader --location=mbr<br /><br /># reboot when done<br />reboot<br /><br />%packages --nobase<br />acl<br />acpid<br />anacron<br />attr<br />authconfig<br />bind-utils<br />cronie<br />cyrus-sasl-plain<br />dhclient<br />ed<br />efibootmgr<br />eject<br />file<br />gpm<br />grub<br />hdparm<br />kbd<br />kernel<br />man<br />nc<br />nss_db<br />openssh-clients<br />openssh-server<br />prelink<br />rng-utils<br />selinux-policy-targeted<br />sendmail<br />setserial<br />setuptool<br />symlinks<br />system-config-firewall-tui<br />tcpdump<br />time<br />traceroute<br />vim-minimal<br />wget<br />which<br />yum-utils<br />%end<br /><br />%post<br /><br /># disable selinux<br />fpath=/etc/selinux/config<br />cp $fpath $fpath.orig<br />cat $fpath.orig | sed 's/^SELINUX=.*/SELINUX=disabled/' > $fpath<br /><br /># enable networking, since we removed networkmanager<br />chkconfig network on<br /><br /># provide good ls colors for a dark background<br />ln -s /etc/DIR_COLORS /root/.dir_colors<br /><br /># now install some muchneeded packages<br />yum install -y bash-completion cobbler dhcp syslinux vim-enhanced<br /><br /># setting server and next_server in /etc/cobbler/settings<br />fpath=/etc/cobbler/settings<br />cp $fpath $fpath.orig<br />cat $fpath.orig | sed 's/127.0.0.1/172.16.1.1/g' | sed 's/manage_dhcp:.*/manage_dhcp: 1/' > $fpath<br /><br /># Must enable selinux boolean to enable Apache and web services components<br />setsebool -P httpd_can_network_connect true<br /><br /># enable tftp<br />fpath=/etc/xinetd.d/tftp<br />cp $fpath $fpath.orig<br />cat $fpath.orig | sed 's/disable.*=.*/disable                 = no/' > $fpath<br /><br /># start httpd at boot<br />chkconfig httpd on<br /><br /># change default password "cobbler" to "trial"<br />for f in /etc/cobbler/*.ks;<br />do<br />    cp $f $f.orig<br />    cat $f.orig | sed 's/rootpw --iscrypted.*/rootpw --iscrypted \\\$1\\\$MZmukub3\\\$SMFCloWQ\/d2jhTC3nZOEK0/' > $f<br />done<br /><br /># only do DHCP on eth1<br />fpath=/etc/sysconfig/dhcpd<br />cp $fpath $fpath.orig<br />cat $fpath.orig | sed 's/DHCPARGS=.*/DHCPARGS=eth1/' > $fpath<br /><br /># eth1 network is 172.16.1.0/24<br />fpath=/etc/cobbler/dhcp.template<br />cp $fpath $fpath.orig<br />cat $fpath.orig | sed 's/192.168.1/172.16.1/g' | grep -v "option routers" > $fpath<br /><br /># start dhcpd at boot<br />chkconfig dhcpd on<br /><br /># sync config<br />cobbler sync<br /><br />%end<br />[/PRE]<br />[DOWNLOAD:http://data.singularity.be/rh/vishnu-20080718]<br /><br /><p>No need to fire up john to crack this crypted password, its "trial"</p><br /><br /><p>Note that I specified a list of packages to install (%packages section) and told kickstart not to install anything else, not even the base system. There is no real-life use for this. The only purpose I had for stripping down a bare Fedora 9 install to the bare minimum, was minimizing installation time.<br /></p><br /><br /><p>The other noteworthy part in this kickstart file is the %post section, which contains a script to be executed on the installed machine after installation completes. Here is what it does:<br /></p><br /><br /><dl><br /><dt>Disable selinux</dt><br /><dd>By default, Fedora 9 switches on SELinux which is a good thing. However, apache was having problems with SELinux when I mounted a DVD under its documentroot. Because I don't have extensive SELinux knowledge to fix this, I took the cheesy way out and just disabled it. Note that you can also just put "selinux --disabled" in the kickstart file, but this way I have an excuse to try and fix my setup later...</dd><br /><dt>Enable networking</dt><br /><dd>This one is pretty silly and I suspect it is a Fedora bug. Because I have stripped down Fedora to the bare minimum, NetworkManager was not installed. I would have expected that Fedora took a moment to think about that and then enable networking without NetworkManager. But it didn't so I have to enable it manually.</dd><br /><dt>Installing needed packages</dt><br /><dd>Install cobbler and friends. Also install bash-completion (I'm a huge fan of bash-completion and am thrilled to have learned that bash-completion scripts will be included in future versions of cobbler!) and vim-enhanced</dd><br /><dt>Fix some settings</dt><br /><dd>After installing cobbler, one would normally run "cobbler check" and fix everything cobbler complains about. Well, I did that in the script.</dd><br /><dt>only do DHCP on eth1</dt><br /><dd>I'm a network administrator and my kind has a serious disgust of rogue DHCP servers on our networks. (So much in fact that I have wirecutters in my desk to cut through UTP cable from offending users). Since this cobbler setup deploys a DHCP server, make sure it only runs on the private network where it belongs: eth1</dd><br /><dt>Modify the dhcp.template file</dt><br /><dd>The private network will use a DHCP range of 172.16.1.0/24</dd><br /><dt>switch on the dhcpd server</dt><br /><dd>.. so it will start at boot</dd><br /><dt>cobbler sync</dt><br /><dd>This command will generate configfiles for all cobbler components from templates and such.</dd><br /></dl><br /><br /><p>To use this kickstart file, boot a Fedora 9 DVD in a virtual machine with 2 networkcards of which eth0 is connected to a DHCP-enabled and internetconnected network. Then at the isolinux menu, press tab and add the following:</p><br /><br />[PRE]<br /> ks=http://data.singularity.be/rh/vishnu-20080718 ksdevice=eth0<br />[/PRE]<br /><br />[FULLIMG:http://data.singularity.be/images/full/undated/cobbler/fedora-isolinux.png]<br /><br /><p><br />In my lab, it takes only 9 minutes and 10 seconds after I press enter on the commandline above untill I get to vishnu's login prompt.<br /></p><br /><br />[FULLIMG:http://data.singularity.be/images/full/undated/cobbler/vishnu-login.png]<br /><br /><h3>Vishnu's first offspring: localhost</h3><br /><br /><p><br />Before we can create cobbler offspring, we need to setup a distribution and such. Normally when importing a distribution, cobbler copies all necessary files to the local disk. But I think that's a bit overkill for a simple labsetup like this. So instead, I will mount the DVD and make it available over HTTP.<br /></p><br /><br /><p>Log in to vishnu and execute these commands:</p><br />[PRE]<br />mkdir /var/www/cobbler/mounted<br />mount /dev/cdrom /var/www/cobbler/mounted<br />cobbler import --name=F9 --mirror=/var/www/cobbler/mounted/ --available-as=http://172.16.1.1/cobbler/mounted/<br />cobbler distro edit --name=F9-i386 --ksmeta="tree=http://@@server@@/cobbler/mounted"<br />cobbler profile edit --name=F9-i386 --kickstart=/etc/cobbler/sample.ks<br />cobbler sync<br />[/PRE]<br /><br /><p>Breaking it down with explanations</p><br />[PRE]mkdir /var/www/cobbler/mounted[/PRE]<br /><p>... creates a mountpoint for the Fedora 9 DVD</p><br /><br />[PRE]mount /dev/cdrom /var/www/cobbler/mounted[/PRE]<br /><p>... mount the DVD there</p><br /><br />[PRE]cobbler import --name=F9 --mirror=/var/www/cobbler/mounted/ --available-as=http://172.16.1.1/cobbler/mounted/[/PRE]<br /><p>... import the distribution, but tell cobbler to not mirror it and instead send the client to the given URL. This URL is the reason why the DVD is mounted under the apache documentroot.</p><br /><br />[PRE]cobbler distro edit --name=F9-i386 --ksmeta="tree=http://@@server@@/cobbler/mounted"[/PRE]<br /><p>... tell cobbler how to fill in the "$tree" variable for this distribution. Normally this is handled by "cobbler import", but this is not a normal setup so we need to fix it manually (for now)</p><br />[PRE]cobbler profile edit --name=F9-i386 --kickstart=/etc/cobbler/sample.ks[/PRE]<br /><p>... for some reason, cobbler gives an error with the above import command and does not link a kickstart file to the F9-i386 profile. Fixing this manually as well, probably a bug, this is what the error looked like:</p><br /><br />[PRE]<br />[root@vishnu ~]# cobbler import --name=F9 --mirror=/var/www/cobbler/mounted/ --available-as=http://172.16.1.1/cobbler/mounted/<br />---------------- (adding distros)<br />- scanning /var/www/cobbler/mounted for architecture info<br />- kernel header found: kernel-headers-2.6.25-14.fc9.i386.rpm<br />- creating new distro: F9-i386<br />- creating new profile: F9-i386<br />- scanning /var/www/cobbler/mounted for architecture info<br />- kernel header found: kernel-headers-2.6.25-14.fc9.i386.rpm<br />- creating new distro: F9-xen-i386<br />- creating new profile: F9-xen-i386<br />---------------- (associating kickstarts)<br />- finding default kickstart template for fedora 9.0<br />/var/www/cobbler/mounted/, /var/www/cobbler/mounted, -1<br />Error: possible symlink traversal?: /var/www/cobbler/mounted<br />[root@vishnu ~]# <br />[/PRE]<br /><br />[PRE]cobbler sync[/PRE]<br /><p>... and sync cobbler configs</p><br /><br /><p>Now you're done !<br />Boot a fresh machine using PXE and you should get a nice menu like this:</p><br /><br />[FULLIMG:http://data.singularity.be/images/full/undated/cobbler/client-pxe-menu.png]<br /><br /><p>Select F9-i386 and press enter. The installation process should take over and do everything automatically from there on.</p><br /><br /><p><br />PS: And what about hiring an army of monkeys with typewriters to generate the kickstart files ? There's a solution for that too. It's called puppet, but that's a story for a later time.<br /></p><br /><br /><br /><br /><br />StevensBlogSpotFilterThing --><br /><h3>How many systems do you administer ?</h3><br /><p><br />If you've ever had to install more than a trivial amount of operating systems, you know how to appreciate good automated installation systems. Most (if not all) Linux distributions noticed this and started building automated installation systems. Debian has FAI and preseeding, Solaris has Jumpstart and Redhat has Kickstart. I must admit I took a stab at this problem myself by preseeding a Debian installation CD, but I've noticed that it takes too much of my time to rebuild the installation CD every time a new Debian release happens.<br /></p><br /><p><br />Lucky for me, Kickstart can supposedly be used to automate other linux installations. That's why I've been looking at Kickstart lately. And what can I say ? It works.<br /></p><br /><p><br />So here we go ! Imagine this: I need to install 500 servers, all with different configurations.<br />I create 500 kickstart files, each defining the setup of a single system. Then I... walk up to every of my 500 systems, put in a CD, boot it, tell it where the kickstart file is and let the thing install.<br /></p><br /><p>Allright, I can see some problems right there.</p><br /><ul><br /><li>First of all, I need to create 500 kickstart files, but that's nothing an army of welltrained monkeys with typewriters can't achieve.</li><br /><li>Second, I need to walk up to every machine and put a CD in, wait till it gets to the isolinux screen and then type in the extra "ks=http://example.com/uniquestringoeshere.ks" at the end of the command line.</li><br /><li>Third, this will approximately take forever. I either need to burn 500 CD's to boot from, or I need to wait for each installation to finish and then move the installation CD from one system to the next.</li><br /></ul><br /><br /><p><br />Man, administering systems is hard. In this light, it's a good thing I don't actually have to administer 500 systems. But the guys at Redhat probably do and they came up with their next great idea.<br /></p><br /><br /><br /><h3>Cobbler: Provisioning made easy</h3><br /><p><br />Almost 9 years ago, Intel invented the Preboot eXecution Environment (PXE), which allows eg diskless computers to boot over network without any user interaction. As part of the boot process, the BIOS might try several disks, CD-drives and floppydisk stations to try and boot, after which it can ask a networkcard to do the same. The networkcard will then try to locate a suitable server from which it can get data to boot up with.<br /></p><br /><p><br />Setting up a TFTP server to do this is not that difficult, but some other steps are involved that combine many small easy tasks into a very big time-consuming list of tasks. This is where cobbler comes in.<br /></p><br /><p><br />Cobbler is a provisioning infrastructure that takes care of all the underlying details and components for you. After installing and configuring cobbler, you basically tell it which CD you want to "publish" through PXE and it just happens. Clients booting through PXE will then get a nice menu where they can select what the want to boot. Even better, you can tell cobbler about a specific system in advance (by registering its MAC address for example) and then that system won't see a menu at all, it will just boot into whatever you specify.<br /></p><br /><small>giggity</small><br /><p>Right, let's look at how cobbler works</p><br /><br /><h3>Cobbler concepts</h3><br /><p><br />There are 3 concepts that pop up all the time and that I needed to understand. I will describe them here as I understand them, AT NO EXTRA COST. You can thank me later.<br /></p><br /><br /><dl><br /><dt>Distributions</dt><br /><dd>This is pretty much self explanatory. A distribution is a ... If I want to install a Centos 5 on a i386 somewhere, I need to make a "distribution" containing the Centos 5 DVD which I can name "Centos 5 i386"</dd><br /><dt>Profiles</dt><br /><dd>This is what you get when you pack a distribution together with a kickstart file. If I want to install a Centos 5 with an apache and SSH server on it, I make a kickstart file for it and glue it together with a "Centos 5" distribution and call that a "Centos 5 Webserver+SSH" profile.</dd><br /><dt>Systems</dt><br /><dd>Associating a certain physical system with a profile happens through a "System" specification. If I want to install my cute yellow 486 here under the table using the "Centos 5 Webserver+SSH" profile, I need to make a system specification by specifying the MAC-address, IP and hostname (tweety) I want for this server. Then I call this system "tweety"</dd><br /><dd><br /></dl><br /><br /><a href="http://data.singularity.be/images/full/undated/cobbler/cobbler.png"><img src="http://data.singularity.be/images/full/undated/cobbler/cobbler.png"></a><br /><br />Here's a little scheme to show how these things fit together. You can have several distributions (in pinkish red), each of which can have several profiles associated with it (green), each of which can have several systems to it (yellow).<br /><br /><h3>Lab setup</h3><br /><br /><p><br />On to the practical side of cobbler. I'm going to setup a cobbler server on Fedora 9 and use that to install another system using Fedora 9 aswell. All of this will be done in Virtualbox.<br /></p><br /><br /><a href="http://data.singularity.be/images/full/undated/cobbler/cobbler_lab_setup.png"><img src="http://data.singularity.be/images/full/undated/cobbler/cobbler_lab_setup.png"></a><br /><br /><p><br />The cobbler server will be named "vishnu" and it will have 2 networkcards: eth0 will be connected to an internet-connected network with DHCP on it. eth1 will be connected to a private network without any traffic on it (static IP). The private network has IP-range 172.16.1.0/24<br /></p><br /><br /><p><br />The machine to be installed using cobbler, has no name really. It has 1 networkcard connected to the private network and boots PXE.<br /></p><br /><br /><h3>Kickstarting the cobbler server: vishnu</h3><br /><p><br />Installing cobbler is fairly simple. Install the base operating system, then use yum to install cobbler, edit some configfiles and you're done. This doesn't include adding distributions or profiles though.<br /></p><br /><br /><p><br />But wait a minute. Do I really want to install vishnu manually ? Booting the CD and going through the installation process after which I have to login, install packages and edit configfiles ?<br />Of course not. This is exactly what kickstart was created for, so let's use it.<br /></p><br /><br /><p>This is the kickstart file I use for vishnu:</p><br /><pre style="background-color: #EEEEEE; border: black 1px dashed; line-height: 100%; padding: 10px;"><br />#version=F9<br />install<br />text<br />cdrom<br />lang en_US.UTF-8<br />keyboard us<br />timezone --utc Europe/Brussels<br /><br /><br /># network settings<br />network --device eth0 --bootproto dhcp --hostname vishnu<br />network --device eth1 --bootproto static --ip 172.16.1.1 --netmask 255.255.255.0<br /><br /># root account<br />authconfig --enableshadow --passalgo=sha512<br />rootpw  --iscrypted $1$6cEAJbnh$TdRTNKsAnwE/PYw3dk/o20<br /><br /># security<br />#firewall --enabled --ssh --dhcp --trust eth1<br />firewall --disabled<br />selinux --enforcing<br /><br /># partitioning and bootloader<br />clearpart --all<br />autopart <br />bootloader --location=mbr<br /><br /># reboot when done<br />reboot<br /><br />%packages --nobase<br />acl<br />acpid<br />anacron<br />attr<br />authconfig<br />bind-utils<br />cronie<br />cyrus-sasl-plain<br />dhclient<br />ed<br />efibootmgr<br />eject<br />file<br />gpm<br />grub<br />hdparm<br />kbd<br />kernel<br />man<br />nc<br />nss_db<br />openssh-clients<br />openssh-server<br />prelink<br />rng-utils<br />selinux-policy-targeted<br />sendmail<br />setserial<br />setuptool<br />symlinks<br />system-config-firewall-tui<br />tcpdump<br />time<br />traceroute<br />vim-minimal<br />wget<br />which<br />yum-utils<br />%end<br /><br />%post<br /><br /># disable selinux<br />fpath=/etc/selinux/config<br />cp $fpath $fpath.orig<br />cat $fpath.orig | sed 's/^SELINUX=.*/SELINUX=disabled/' > $fpath<br /><br /># enable networking, since we removed networkmanager<br />chkconfig network on<br /><br /># provide good ls colors for a dark background<br />ln -s /etc/DIR_COLORS /root/.dir_colors<br /><br /># now install some muchneeded packages<br />yum install -y bash-completion cobbler dhcp syslinux vim-enhanced<br /><br /># setting server and next_server in /etc/cobbler/settings<br />fpath=/etc/cobbler/settings<br />cp $fpath $fpath.orig<br />cat $fpath.orig | sed 's/127.0.0.1/172.16.1.1/g' | sed 's/manage_dhcp:.*/manage_dhcp: 1/' > $fpath<br /><br /># Must enable selinux boolean to enable Apache and web services components<br />setsebool -P httpd_can_network_connect true<br /><br /># enable tftp<br />fpath=/etc/xinetd.d/tftp<br />cp $fpath $fpath.orig<br />cat $fpath.orig | sed 's/disable.*=.*/disable                 = no/' > $fpath<br /><br /># start httpd at boot<br />chkconfig httpd on<br /><br /># change default password "cobbler" to "trial"<br />for f in /etc/cobbler/*.ks;<br />do<br />    cp $f $f.orig<br />    cat $f.orig | sed 's/rootpw --iscrypted.*/rootpw --iscrypted \\\$1\\\$MZmukub3\\\$SMFCloWQ\/d2jhTC3nZOEK0/' > $f<br />done<br /><br /># only do DHCP on eth1<br />fpath=/etc/sysconfig/dhcpd<br />cp $fpath $fpath.orig<br />cat $fpath.orig | sed 's/DHCPARGS=.*/DHCPARGS=eth1/' > $fpath<br /><br /># eth1 network is 172.16.1.0/24<br />fpath=/etc/cobbler/dhcp.template<br />cp $fpath $fpath.orig<br />cat $fpath.orig | sed 's/192.168.1/172.16.1/g' | grep -v "option routers" > $fpath<br /><br /># start dhcpd at boot<br />chkconfig dhcpd on<br /><br /># sync config<br />cobbler sync<br /><br />%end<br /></pre><br /><div style="padding: 2px; background-color: #f0f0f0;"><a href="http://data.singularity.be/rh/vishnu-20080718"><img style="vertical-align: middle; padding: 2px;" src="http://data.singularity.be/images/icon/download-icon.png">Download http://data.singularity.be/rh/vishnu-20080718</a></div><br /><br /><p>No need to fire up john to crack this crypted password, its "trial"</p><br /><br /><p>Note that I specified a list of packages to install (%packages section) and told kickstart not to install anything else, not even the base system. There is no real-life use for this. The only purpose I had for stripping down a bare Fedora 9 install to the bare minimum, was minimizing installation time.<br /></p><br /><br /><p>The other noteworthy part in this kickstart file is the %post section, which contains a script to be executed on the installed machine after installation completes. Here is what it does:<br /></p><br /><br /><dl><br /><dt>Disable selinux</dt><br /><dd>By default, Fedora 9 switches on SELinux which is a good thing. However, apache was having problems with SELinux when I mounted a DVD under its documentroot. Because I don't have extensive SELinux knowledge to fix this, I took the cheesy way out and just disabled it. Note that you can also just put "selinux --disabled" in the kickstart file, but this way I have an excuse to try and fix my setup later...</dd><br /><dt>Enable networking</dt><br /><dd>This one is pretty silly and I suspect it is a Fedora bug. Because I have stripped down Fedora to the bare minimum, NetworkManager was not installed. I would have expected that Fedora took a moment to think about that and then enable networking without NetworkManager. But it didn't so I have to enable it manually.</dd><br /><dt>Installing needed packages</dt><br /><dd>Install cobbler and friends. Also install bash-completion (I'm a huge fan of bash-completion and am thrilled to have learned that bash-completion scripts will be included in future versions of cobbler!) and vim-enhanced</dd><br /><dt>Fix some settings</dt><br /><dd>After installing cobbler, one would normally run "cobbler check" and fix everything cobbler complains about. Well, I did that in the script.</dd><br /><dt>only do DHCP on eth1</dt><br /><dd>I'm a network administrator and my kind has a serious disgust of rogue DHCP servers on our networks. (So much in fact that I have wirecutters in my desk to cut through UTP cable from offending users). Since this cobbler setup deploys a DHCP server, make sure it only runs on the private network where it belongs: eth1</dd><br /><dt>Modify the dhcp.template file</dt><br /><dd>The private network will use a DHCP range of 172.16.1.0/24</dd><br /><dt>switch on the dhcpd server</dt><br /><dd>.. so it will start at boot</dd><br /><dt>cobbler sync</dt><br /><dd>This command will generate configfiles for all cobbler components from templates and such.</dd><br /></dl><br /><br /><p>To use this kickstart file, boot a Fedora 9 DVD in a virtual machine with 2 networkcards of which eth0 is connected to a DHCP-enabled and internetconnected network. Then at the isolinux menu, press tab and add the following:</p><br /><br /><pre style="background-color: #EEEEEE; border: black 1px dashed; line-height: 100%; padding: 10px;"><br /> ks=http://data.singularity.be/rh/vishnu-20080718 ksdevice=eth0<br /></pre><br /><br /><a href="http://data.singularity.be/images/full/undated/cobbler/fedora-isolinux.png"><img src="http://data.singularity.be/images/full/undated/cobbler/fedora-isolinux.png"></a><br /><br /><p><br />In my lab, it takes only 9 minutes and 10 seconds after I press enter on the commandline above untill I get to vishnu's login prompt.<br /></p><br /><br /><a href="http://data.singularity.be/images/full/undated/cobbler/vishnu-login.png"><img src="http://data.singularity.be/images/full/undated/cobbler/vishnu-login.png"></a><br /><br /><h3>Vishnu's first offspring: localhost</h3><br /><br /><p><br />Before we can create cobbler offspring, we need to setup a distribution and such. Normally when importing a distribution, cobbler copies all necessary files to the local disk. But I think that's a bit overkill for a simple labsetup like this. So instead, I will mount the DVD and make it available over HTTP.<br /></p><br /><br /><p>Log in to vishnu and execute these commands:</p><br /><pre style="background-color: #EEEEEE; border: black 1px dashed; line-height: 100%; padding: 10px;"><br />mkdir /var/www/cobbler/mounted<br />mount /dev/cdrom /var/www/cobbler/mounted<br />cobbler import --name=F9 --mirror=/var/www/cobbler/mounted/ --available-as=http://172.16.1.1/cobbler/mounted/<br />cobbler distro edit --name=F9-i386 --ksmeta="tree=http://@@server@@/cobbler/mounted"<br />cobbler profile edit --name=F9-i386 --kickstart=/etc/cobbler/sample.ks<br />cobbler sync<br /></pre><br /><br /><p>Breaking it down with explanations</p><br /><pre style="background-color: #EEEEEE; border: black 1px dashed; line-height: 100%; padding: 10px;">mkdir /var/www/cobbler/mounted</pre><br /><p>... creates a mountpoint for the Fedora 9 DVD</p><br /><br /><pre style="background-color: #EEEEEE; border: black 1px dashed; line-height: 100%; padding: 10px;">mount /dev/cdrom /var/www/cobbler/mounted</pre><br /><p>... mount the DVD there</p><br /><br /><pre style="background-color: #EEEEEE; border: black 1px dashed; line-height: 100%; padding: 10px;">cobbler import --name=F9 --mirror=/var/www/cobbler/mounted/ --available-as=http://172.16.1.1/cobbler/mounted/</pre><br /><p>... import the distribution, but tell cobbler to not mirror it and instead send the client to the given URL. This URL is the reason why the DVD is mounted under the apache documentroot.</p><br /><br /><pre style="background-color: #EEEEEE; border: black 1px dashed; line-height: 100%; padding: 10px;">cobbler distro edit --name=F9-i386 --ksmeta="tree=http://@@server@@/cobbler/mounted"</pre><br /><p>... tell cobbler how to fill in the "$tree" variable for this distribution. Normally this is handled by "cobbler import", but this is not a normal setup so we need to fix it manually (for now)</p><br /><pre style="background-color: #EEEEEE; border: black 1px dashed; line-height: 100%; padding: 10px;">cobbler profile edit --name=F9-i386 --kickstart=/etc/cobbler/sample.ks</pre><br /><p>... for some reason, cobbler gives an error with the above import command and does not link a kickstart file to the F9-i386 profile. Fixing this manually as well, probably a bug, this is what the error looked like:</p><br /><br /><pre style="background-color: #EEEEEE; border: black 1px dashed; line-height: 100%; padding: 10px;"><br />[root@vishnu ~]# cobbler import --name=F9 --mirror=/var/www/cobbler/mounted/ --available-as=http://172.16.1.1/cobbler/mounted/<br />---------------- (adding distros)<br />- scanning /var/www/cobbler/mounted for architecture info<br />- kernel header found: kernel-headers-2.6.25-14.fc9.i386.rpm<br />- creating new distro: F9-i386<br />- creating new profile: F9-i386<br />- scanning /var/www/cobbler/mounted for architecture info<br />- kernel header found: kernel-headers-2.6.25-14.fc9.i386.rpm<br />- creating new distro: F9-xen-i386<br />- creating new profile: F9-xen-i386<br />---------------- (associating kickstarts)<br />- finding default kickstart template for fedora 9.0<br />/var/www/cobbler/mounted/, /var/www/cobbler/mounted, -1<br />Error: possible symlink traversal?: /var/www/cobbler/mounted<br />[root@vishnu ~]# <br /></pre><br /><br /><pre style="background-color: #EEEEEE; border: black 1px dashed; line-height: 100%; padding: 10px;">cobbler sync</pre><br /><p>... and sync cobbler configs</p><br /><br /><p>Now you're done !<br />Boot a fresh machine using PXE and you should get a nice menu like this:</p><br /><br /><a href="http://data.singularity.be/images/full/undated/cobbler/client-pxe-menu.png"><img src="http://data.singularity.be/images/full/undated/cobbler/client-pxe-menu.png"></a><br /><br /><p>Select F9-i386 and press enter. The installation process should take over and do everything automatically from there on.</p><br /><br /><p><br />PS: And what about hiring an army of monkeys with typewriters to generate the kickstart files ? There's a solution for that too. It's called puppet, but that's a story for a later time.<br /></p>