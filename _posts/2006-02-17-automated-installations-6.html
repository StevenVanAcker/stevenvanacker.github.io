---
layout: post
title: automated installations (6)
date: '2006-02-17T09:47:00.000+01:00'
author: Steven Van Acker
tags: 
modified_time: '2008-01-16T09:27:08.645+01:00'
blogger_id: tag:blogger.com,1999:blog-5513234137363262204.post-7613675762000924507
blogger_orig_url: http://www.singularity.be/2006/02/automated-installations-6.html
---

The bugreports and patches are on their way to bugs.debian.org.<br /><br />I've been looking at the whole hostname thing again. <br />The code in the base-config package is executed after the first reboot. That means the hostname is already set at that point (by the netcfg package :( )<br /><br />Some things to keep in mind when altering base-config udeb:<br /><br /><ul><br /><li>it has an md5sums file you need to regenerate</li><br /><li>the Packages file is somewhere else</li><br /><li>the Packages file contains a "Size:" field you need to modify</li><br /></ul><br /><br />I've attached the scripts to pack and unpack the base-config package.<br /><br />By inserting a "sleep 1800" into the script to set the hostname, I was able to view what files existed before the script ran. My idea is that I can maybe alter those files with the real hostname and then continue the installation.<br /><br />These files contain the hostname right before the base-config script:<br /><br /><pre><br />/etc/hostname<br />/etc/hosts<br />/etc/motd<br />/etc/exim4/update-exim4.conf.conf<br />/etc/mailname<br />/var/lib/exim4/config.autogenerated<br />/var/cache/debconf/config.dat<br />/var/cache/debconf/config.dat-old<br />/var/log/syslog<br />/var/log/auth.log<br />/var/log/debian-installer/cdebconf/questions.dat<br />/var/log/kern.log<br />/var/log/user.log<br />/var/log/debug<br />/var/log/messages<br /></pre><br /><br />Notice how /var/log/user.log exists but seems to be erased after the installation completes ?<br />These files are created after the base-config script:<br /><br /><pre><br />/etc/ssh/ssh_host_rsa_key.pub<br />/etc/ssh/ssh_host_dsa_key.pub<br />/var/log/exim4/mainlog<br />/var/log/daemon.log<br />/var/log/lpr.log<br />/var/spool/mail/mail<br />/var/mail/mail<br /></pre><br /><br />OK, So from all the files that already exist, I decide that these are important:<br /><pre><br />/etc/hostname<br />/etc/hosts<br />/etc/motd<br />/etc/mailname<br />/var/cache/debconf/config.dat<br />/var/cache/debconf/config.dat-old<br /></pre><br /><br />And these are not:<br /><pre><br />/etc/exim4/update-exim4.conf.conf<br />/var/lib/exim4/config.autogenerated<br />/var/log/syslog<br />/var/log/auth.log<br />/var/log/debian-installer/cdebconf/questions.dat<br />/var/log/kern.log<br />/var/log/user.log<br />/var/log/debug<br />/var/log/messages<br /></pre><br /><br />The reason why exim4 config is not important is because exim will be removed in favor of postfix anyway. The rest of the unimportant files are just logs.<br /><br />Let's review the files that need to be changed:<br /><dl><br /><dt>/etc/hostname</dt><br /><dd>This file contains the hostname and is generated by the netcfg package. This is one we need to change.</dd><br /><dt>/etc/hosts</dt><br /><dd>This file contains IP to hostname mappings and is also generated by the netcfg package. We will need our own custom version of this file anyway, so maybe it can be generated by a custom package later on.</dd><br /><dt>/etc/motd</dt><br /><dd>This file contains the message of the day and is generated at boot by /etc/init.d/bootmisc.sh from whatever uname returns. Could not care less about it :)</dd><br /><dt>/etc/mailname</dt><br /><dd>This file seems to be generated by the exim4 package. Since we will remove exim4 and install postfix on all machines, we can have postfix regenerate it.</dd><br /><dt>/var/cache/debconf/config.dat</dt><br /><dt>/var/cache/debconf/config.dat-old</dt><br /><dd>These files are used by debconf and contain the answers to the questions asked by debconf. The hostname variable can be changed with the db_set function</dd><br /></dl><br /><br />By changing in the file "/usr/lib/base-config/menu/hostname" <br /><pre><br /># Prompt for the hostname, using the current name, if any, as the default.<br />hostname=<br />LOOPCOUNT=2<br />while [ -z "$hostname" ]; do<br /></pre><br />into<br /><pre><br /># Prompt for the hostname, using the current name, if any, as the default.<br />hostname=myhostname<br />LOOPCOUNT=2<br />while [ -z "$hostname" ]; do<br /></pre><br /><br />I'm able to change both /etc/hostname and uname.<br />But, it would be even better if I could use the debconf value stored in base-config/get_hostname<br />And yet even better if I could ask this question at the start of the installation.<br /><br />For this, I remembered that when I installed <a href='http://www.hands.com/d-i/'>dashslashdash</a> (and of course looked under the hood), a script was installed that messes with the order questions are asked.<br /><br />...<br /><br />After looking through the scripts that make up the installer, I came to the conclusion that working my way around patching netcfg will be more complex than modifying netcfg itself.<br />After all, all I need to do in netcfg is change the priority of 1 question (I hope!)<br /><br />The question now becomes: how do I compile netcfg ? Because it seems to use an old libc version and some libraries that only exist in the installer environment.<br /><br />At first glance, I see no easy way to recompile the netcfg udeb. Maybe I could recompile the entire debian installer, but thats too much work and too much could go wrong.<br /><br />I found the code I need to modify (netcfg-common.c line 520, function netcfg_get_hostname())<br /><pre><br />        debconf_input(client, "high", template);<br /></pre><br /><br />That "high" should be "critical"...<br /><br />I'm considering a binary patch...<br />According to IDE, the instruction I want to modify is located at 0x8049d1d and I have to change 0x804ca63 ("high") to 0x804cada ("critical")<br /><br />So, whipping up xxd:<br /><pre><br />(deepstar/tachyon) /tmp/udebtest/data/bin$ mv netcfg netcfg.old<br />(deepstar/tachyon) /tmp/udebtest/data/bin$ xxd netcfg.old | sed 's/0001d10: 740a c705 8cec 0408 0000 0000 5368 63ca/0001d10: 740a c705 8cec 0408 0000 0000 5368 daca/' | xxd -r &gt; netcfg<br /></pre><br /><br />Well, it still doesn't work.<br />I'm getting tired of this...<br /><br />I did a preliminary test on a real system with 2 disks and 4 networkcards and saw the following problems:<br /><br /><ul><br /><li>netcfg had problems getting online because the wrong networkcard was plugged in. Since each networkcard is connected to another network, netcfg needs to pick the correct networkcard to use. A value of "auto" is not good enough :( Furthermore, since I don't know which order the networkcards are detected, I can't tell in advance which networkcard should be used</li><br /><li>When installing grub, it did not know which disk to install to. Maybe this is some preseed variable ?</li><br /></ul><br /><br />I'm getting more and more convinced that ditching netcfg and writing my own version is the way to go. The postinst script of netcfg just does "exec netcfg". I can replace that with my own code :)<br />I checked what is available in the initrd and found: ifconfig, route, iproute and netcat.<br />That should be enough to do some network configuration magic.<br /><br />After the testsystem was setup, my collegue set it some more and sent me the list of changes.<br />They will be documented on our internal wiki.<br />One thing I should look at, is setting the timezone with tzconfig. Apparently, this is set to a wrong value. I hope there is a debconf variable for this.