<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      new desktop: first steps &middot; Singularity.be
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Singularity.be
        </a>
      </h1>
      <p class="lead">Steven Van Acker's blog</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">About</a>
          
        
      
        
          
        
      
        
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/projects/">Projects</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/publications/">Publications</a>
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
    </nav>

    <!-- <p>&copy; 2016. All rights reserved.</p> -->
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">new desktop: first steps</h1>
  <span class="post-date">18 Mar 2007</span>
  Now that I have some idea of where I want to go with my new desktop, it's time to take a closer look at all the components and see if I can get them to work.<br /><br />On my homecomputer, I have <a href="http://www.vmware.com/products/server/">VMWare Server</a> installed, which I will use to install a test-computer and test out several components.<br /><br />Then, when I'm happy with how all components work together, I'll install it on my laptop.<br /><br />At work I have a VMWare Workstation, which allows me to take snapshots at regular intervals. I don't seem to have that functionality in VMWare Server and I think that's bad :( But I'll try to live with it.<br /><br />While I'm downloading the <a href="ftp://ftp.belnet.be/mirror/ubuntu.com/releases/6.10">Ubuntu Desktop 6.10 ISO</a>, I've been thinking about which component to start with. I will need VPN, Asterisk, subversion and an encrypted filesystem.<br /><br />I decided to start with the encrypted filesystem, since it's the only component I need that doesn't require me to setup some server to test with.<br /><br />On my old Debian-installation on my laptop, I use crypt-setup to encrypt an entire filesystem. <a href="http://www.movingtofreedom.org/2007/02/21/howto-encfs-encrypted-file-system-in-ubuntu-and-fedora-gnu-linux/">This guy</a> followed the same path and complains about not being able to resize the encrypted filesystem. You create it with a fixed size and you're stuck with it. Fair enough. But that's not the reason I would go with <a href="http://encfs.sourceforge.net/">EncFS</a>. When I log into Ubuntu, I want my encrypted filesystem/directory ready for use. I don't want a separate script to enable it or anything. Mounting filesystems at login is done with the PAM framework, and it so happens that <a href="http://choffee.co.uk/ramble/2006/06/02/paranoia-at-home/">EncFS has a PAM plugin</a><br /><br />Allright, ubuntu finally installed and I created a snapshot. First thing to do to install encfs and libpam-encfs, is to enable universe and multiverse in /etc/apt/sources.list. Then run apt-get update and apt-get install encfs libpam-encfs.<br /><br />Apparently, the fuse kernel module is put into /etc/modules automatically. But it doesn't hurt to modprobe it to make sure.<br /><br />Now comes the fun part, trying out this encfs thing.<br />The main tool seems to be "encfs". Before being able to use the encfs, you need to create one. Encfs will use 2 directories: one where it stores the encrypted stuff, another where it mounts the unencrypted stuff.  Both directories need to be passed as absolute locations.<br /><br />In my case, I created /home/deepstar/test/encrypted and /home/deepstar/test/mounted and ran "encfs /home/deepstar/test/encrypted /home/deepstar/test/mounted".<br />When it asked to enter an option, I went for the paranoia one ;)<br />After entering a password (the same as my login password, this is important to get PAM working later on), encfs complained about "permission denied" and the kernel module not being loaded.<br /><br />Apparently, I had to run this as root with sudo. When I tried again (adding sudo in front), it worked and didn't ask to create anything this time. This means the whole process was successful as non-root, but I was unable to mount it untill I did sudo.<br /><br />Anyway. The permissions on this new directory are not ok since I can't go in the directory as a regular user. Root can add files in it and they are encrypted. So far so good :)<br /><br />The problem with the permissions seems to be because my regular user was not part of the fuse group. I added it with "adduser deepstar fuse" and then restarted X (logging out and logging in again).<br /><br />Encfs still complains, but this time because the permissions on /dev/fuse are wrong. (Who wrote this stuff anyways ?!)<br />"chown root.fuse /dev/fuse" will fix that, but probably only temporarily because ubuntu uses udev which regenerates /dev every time you reboot.<br /><br />An interesting property of Encfs seems to be that only the owner of the filesystem can actually use it. Any other user (including root!) can't look into the unencrypted filesystem and not even query metadata like filemodes or size.<br /><br />Now that the encfs exists, I can look at the PAM settings. According to the documentation in /usr/share/doc/libpam_encfs, I need to edit /etc/pam.d/common-auth. I added this line in fron of pam_unix.so:<br /><pre><br />auth    sufficient    pam_encfs.so<br /></pre><br /><br />and appended "use_first_pass" to the pam_unix.so line.<br /><br />Source: http://choffee.co.uk/ramble/2006/06/02/paranoia-at-home/<br /><br />The original documentation also advises to unmount the filesystem on logout, but mentions that this will happen automagically after 1 minute if using the default configuration in /etc/security/pam_encfs.conf<br /><br />According to the link above, I should edit /etc/security/pam_encfs.conf and change allow_other to allow_root.<br />Then /home/.enc should be created, mounted to /var/tmp/deepstar, unmounted.<br />At the next login everything should work fine, but it doesn't. I can't even login now :)<br /><br />[update lots of hours later]<br /><br />Allright, it got me pretty pissed now. <br />Here are the files that you need to check in order to get things working:<br /><br /><pre><br />/dev/fuse      ... make sure permissions and owner are correct<br />fuse kernel module ... should be loaded<br />source mountpoint ... make sure all files are owned by the user who owns the encrypted share<br />destination mountpoint ... make sure it is empty and owned by the user who owns the encrypted share<br />/etc/pam.d/common-auth ... should contain "auth sufficient pam_encfs.so" and "use_first_pass" after pam_unix.so<br />/etc/pam.d/common-session ... should have "session required pam_encfs.so" as first line<br />/etc/fuse.conf ... should have "user_allow_other" in it, without the quotes<br />/etc/security/pam_encfs.conf ... should include full username, source and destination paths and have allow_root instead of allow_other<br /></pre><br /><br />In case of problems, you can login to localhost with ssh and try to mount the share manually with "encfs /home/deepstarenc /home/deepstar -- -o allow_root"<br />It should print out what is wrong...<br /><br /><br />OK, now things work when I log in with SSH, but not when I use gdm (graphical login screen). The problem seems to be <br /><pre><br />** (gnome-session:4289): WARNING **: Unable to lock ICE authority file: /home/deepstar/.ICEauthority<br /></pre><br /><br />I fixed it with a tip from <a href="http://www.linuxquestions.org/questions/showthread.php?t=403160&page=3">this site</a>:<br /><pre><br />The trick is the right one, but the file where it is applied is not. In fact you need to edit the file <br /><br />/etc/gdm/Xsession<br /><br />somewhere in a convenient place (i did it right after PROGNAME=Xsession) you add:<br /><br />Quote:<br />    ICEAUTHORITY="tmp/ICEauthority-${user}"<br />    export ICEAUTHORITY<br /></pre><br /><br />But that tip seems to contain a typo (no / before tmp/ICEauthority)<br />I added these lines right after "PROGNAME=Xsession" in /etc/gdm/Xsession:<br /><pre><br />ICEAUTHORITY="/tmp/ICEauthority-${user}"<br />export ICEAUTHORITY<br /></pre><br /><br />And now it works !
</div>


    </div>

  </body>
</html>
