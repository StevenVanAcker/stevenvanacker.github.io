<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      querying subnets &middot; Singularity.be
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Singularity.be
        </a>
      </h1>
      <p class="lead">Steven Van Acker's blog</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">About</a>
          
        
      
        
          
        
      
        
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/projects/">Projects</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/publications/">Publications</a>
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
    </nav>

    <!-- <p>&copy; 2016. All rights reserved.</p> -->
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">querying subnets</h1>
  <span class="post-date">03 Mar 2007</span>
  It's been a busy week, too busy to play around with HPPC code.<br />I've been reading and rereading the Feldmann paper that first proposes a FIS tree and trying to make sense of their space/time complexities. I got no further...<br /><br />Anyway, I might not have been able to play with code, but I had a couple of remarks and ideas about it.<br /><br />First, I use a list of numbers stored with each treenode: the rule id's of all rules that match the referenced node.<br />But there's a problem with it. Rules change and so do the numbers...<br />If I insert a rule at the top of a chain, it will be rule 1 and all other rules will shift 1 position. To keep the rules in sync with the tree, I'd have to update all numbers in that tree which would be enormously inefficient.<br /><br />So, instead of using numbers, I know use a list of void pointers. Maybe they will point to the original rule, or to another structure that contains the rule ID.<br /><br />Another idea I had originated from my job. I maintain a firewall with 9000 rules (all listed in a bash script... no my idea)<br />From time to time, a network administrator will ask to add or remove a rule, list all rules that apply to his network, or claim that the firewall blocks certain traffic.<br />Debugging a firewall that size is madness. Especially because the rules are not really structured and lots of filtering is done.<br /><br />I had the idea to create a tool that filters all rules for a certain subnet, from the ruleset. Listing all rules that apply to a certain subnet would not be a problem then. Debugging a network problem could be done in the same way by looking which rules apply to a certain packet traversing the firewall. And adding/removing rules... well I've wanted to restructure the entire firewall anyway. A tool to do structured queries would be a nice thing to have when doing that (verifying that the new firewall does the same filtering as the old)<br /><br />Querying a single IP address is easy when you have a segment tree. Just descend down the matching nodes of the tree and add all matching rule numbers to a list.<br /><br />Querying an entire subnet is less easy. Matching a /17 network for example would be the same as matching 32000 IP's. Of course it would be stupid to do it like this while we can abuse the treestructure.<br /><br />[G2:11061]<br />(The picture shows the dataset under test and the query was for 193.190.0.0/16)<br /><br />There are 2 cases to consider: the subnet we're looking for has an exact match in the tree, or it doesn't.<br /><br />If it has an exact match, then we can just descend the matching nodes of the tree and add the relevant rules untill we reach the subnet-node (just as we would do for an IP). And because everything under the subnet-node is by definition a part of the subnet we are looking for, we can add ALL rules under that subnet node.<br /><br />If there is no exact match (like in the picture, the queried subnet would be located where the red arrow points), we need to look for the subtree under the last matching node, attached to the correct branch. The treenode we find there will be a part of the subnet we are querying for and we can add all it's rule numbers.<br /><br />While implementing this I ran into a bug. In my dataset 127.0.0.0/8 and 10.0.0.0/8 were added to the tree under 0.0.0.0/0. This results in a redundant node 0.0.0.0/1 at which point both 127/8 (01111111) and 10/8 (00001010) can be added in different branches. My code added 127/8 under branch 0 and 10/8 under branch 1: the exact opposite of what it should have been.<br /><br />I tracked the bug down to a piece of the code looking like this:<br /><pre><br />branch_a = ...;<br />branch_a = ...;<br /></pre><br /><br />Just to show how much a typo can screw things up :)<br />
</div>


    </div>

  </body>
</html>
