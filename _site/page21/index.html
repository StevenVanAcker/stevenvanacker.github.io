<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Singularity.be &middot; Flawed logic inspecting flawed logic
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Singularity.be
        </a>
      </h1>
      <p class="lead">Steven Van Acker's blog</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">About</a>
          
        
      
        
          
        
      
        
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/projects/">Projects</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/publications/">Publications</a>
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
    </nav>

    <!-- <p>&copy; 2016. All rights reserved.</p> -->
  </div>
</div>


    <div class="content container">
      <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2008/04/27/kampvuur/">
        Kampvuur !
      </a>
    </h1>

    <span class="post-date">27 Apr 2008</span>

    <!-- StevensBlogSpotFilterThing<br />Na een dagje hard werken, een kampvuur!<br /><br />[IMG:2008-04-27/CIMG1363.JPG][IMG:2008-04-27/CIMG1364.JPG][IMG:2008-04-27/CIMG1365.JPG][IMG:2008-04-27/CIMG1366.JPG][IMG:2008-04-27/CIMG1367.JPG][IMG:2008-04-27/CIMG1368.JPG][IMG:2008-04-27/CIMG1369.JPG]<br /><br />En hier trouwens een bewijs dat Cif werkt:<br />[IMG:2008-04-27/CIMG1362.JPG]<br /><br />StevensBlogSpotFilterThing --><br />Na een dagje hard werken, een kampvuur!<br /><br /><a href="http://data.singularity.be/images/full/2008-04-27/CIMG1363.JPG"><img src="http://data.singularity.be/images/thumb/2008-04-27/CIMG1363.JPG.png"></a><a href="http://data.singularity.be/images/full/2008-04-27/CIMG1364.JPG"><img src="http://data.singularity.be/images/thumb/2008-04-27/CIMG1364.JPG.png"></a><a href="http://data.singularity.be/images/full/2008-04-27/CIMG1365.JPG"><img src="http://data.singularity.be/images/thumb/2008-04-27/CIMG1365.JPG.png"></a><a href="http://data.singularity.be/images/full/2008-04-27/CIMG1366.JPG"><img src="http://data.singularity.be/images/thumb/2008-04-27/CIMG1366.JPG.png"></a><a href="http://data.singularity.be/images/full/2008-04-27/CIMG1367.JPG"><img src="http://data.singularity.be/images/thumb/2008-04-27/CIMG1367.JPG.png"></a><a href="http://data.singularity.be/images/full/2008-04-27/CIMG1368.JPG"><img src="http://data.singularity.be/images/thumb/2008-04-27/CIMG1368.JPG.png"></a><a href="http://data.singularity.be/images/full/2008-04-27/CIMG1369.JPG"><img src="http://data.singularity.be/images/thumb/2008-04-27/CIMG1369.JPG.png"></a><br /><br />En hier trouwens een bewijs dat Cif werkt:<br /><a href="http://data.singularity.be/images/full/2008-04-27/CIMG1362.JPG"><img src="http://data.singularity.be/images/thumb/2008-04-27/CIMG1362.JPG.png"></a>
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2008/04/26/designing-bbq/">
        Designing a BBQ
      </a>
    </h1>

    <span class="post-date">26 Apr 2008</span>

    <!-- StevensBlogSpotFilterThing<br />After a whole year of welding class, I'm able to weld pretty well. So now I need a project to use that new skill. Since the summer is coming up and my current BBQ is kindof small, I've decided to weld a BBQ set. It will be bigger than the one I have now, rectangular and most importantly: I will be able to fold it together into a suitcase.<br /><br />To test if my design works, I made a smallscale version (scale 5 to 1) with cardboard and tape. It took quite a long time, but I'm happy with the result.<br /><br />Creating the metal square tubing in cardboard:<br />[IMG:2008-04-26-bbq/CIMG1343.JPG][IMG:2008-04-26-bbq/CIMG1344.JPG][IMG:2008-04-26-bbq/CIMG1345.JPG][IMG:2008-04-26-bbq/CIMG1347.JPG]<br /><br />Some unexpected visitors:<br />[IMG:2008-04-26-bbq/CIMG1346.JPG]<br /><br />Constructing rectangular frames for the support structure:<br />[IMG:2008-04-26-bbq/CIMG1348.JPG][IMG:2008-04-26-bbq/CIMG1349.JPG][IMG:2008-04-26-bbq/CIMG1350.JPG][IMG:2008-04-26-bbq/CIMG1351.JPG]<br /><br />Making the BBQ box for the coals:<br />[IMG:2008-04-26-bbq/CIMG1352.JPG]<br /><br />Linking the frames together with joints (actually tape):<br />[IMG:2008-04-26-bbq/CIMG1353.JPG]<br /><br />Attaching the BBQ box, first attempt: FAIL!<br />[IMG:2008-04-26-bbq/CIMG1354.JPG]<br /><br />Attaching triangular supports to reinforce the base:<br />[IMG:2008-04-26-bbq/CIMG1355.JPG][IMG:2008-04-26-bbq/CIMG1356.JPG]<br /><br />Making and attaching the closing lid of the "suitcase":<br />[IMG:2008-04-26-bbq/CIMG1357.JPG][IMG:2008-04-26-bbq/CIMG1358.JPG][IMG:2008-04-26-bbq/CIMG1359.JPG][IMG:2008-04-26-bbq/CIMG1360.JPG]<br /><br />All done!<br /><br />I'm going to the hardware store tonmorrow to see what kind of materials I can use to make this, and how much it will cost.<br /><br /><br />StevensBlogSpotFilterThing --><br />After a whole year of welding class, I'm able to weld pretty well. So now I need a project to use that new skill. Since the summer is coming up and my current BBQ is kindof small, I've decided to weld a BBQ set. It will be bigger than the one I have now, rectangular and most importantly: I will be able to fold it together into a suitcase.<br /><br />To test if my design works, I made a smallscale version (scale 5 to 1) with cardboard and tape. It took quite a long time, but I'm happy with the result.<br /><br />Creating the metal square tubing in cardboard:<br /><a href="http://data.singularity.be/images/full/2008-04-26-bbq/CIMG1343.JPG"><img src="http://data.singularity.be/images/thumb/2008-04-26-bbq/CIMG1343.JPG.png"></a><a href="http://data.singularity.be/images/full/2008-04-26-bbq/CIMG1344.JPG"><img src="http://data.singularity.be/images/thumb/2008-04-26-bbq/CIMG1344.JPG.png"></a><a href="http://data.singularity.be/images/full/2008-04-26-bbq/CIMG1345.JPG"><img src="http://data.singularity.be/images/thumb/2008-04-26-bbq/CIMG1345.JPG.png"></a><a href="http://data.singularity.be/images/full/2008-04-26-bbq/CIMG1347.JPG"><img src="http://data.singularity.be/images/thumb/2008-04-26-bbq/CIMG1347.JPG.png"></a><br /><br />Some unexpected visitors:<br /><a href="http://data.singularity.be/images/full/2008-04-26-bbq/CIMG1346.JPG"><img src="http://data.singularity.be/images/thumb/2008-04-26-bbq/CIMG1346.JPG.png"></a><br /><br />Constructing rectangular frames for the support structure:<br /><a href="http://data.singularity.be/images/full/2008-04-26-bbq/CIMG1348.JPG"><img src="http://data.singularity.be/images/thumb/2008-04-26-bbq/CIMG1348.JPG.png"></a><a href="http://data.singularity.be/images/full/2008-04-26-bbq/CIMG1349.JPG"><img src="http://data.singularity.be/images/thumb/2008-04-26-bbq/CIMG1349.JPG.png"></a><a href="http://data.singularity.be/images/full/2008-04-26-bbq/CIMG1350.JPG"><img src="http://data.singularity.be/images/thumb/2008-04-26-bbq/CIMG1350.JPG.png"></a><a href="http://data.singularity.be/images/full/2008-04-26-bbq/CIMG1351.JPG"><img src="http://data.singularity.be/images/thumb/2008-04-26-bbq/CIMG1351.JPG.png"></a><br /><br />Making the BBQ box for the coals:<br /><a href="http://data.singularity.be/images/full/2008-04-26-bbq/CIMG1352.JPG"><img src="http://data.singularity.be/images/thumb/2008-04-26-bbq/CIMG1352.JPG.png"></a><br /><br />Linking the frames together with joints (actually tape):<br /><a href="http://data.singularity.be/images/full/2008-04-26-bbq/CIMG1353.JPG"><img src="http://data.singularity.be/images/thumb/2008-04-26-bbq/CIMG1353.JPG.png"></a><br /><br />Attaching the BBQ box, first attempt: FAIL!<br /><a href="http://data.singularity.be/images/full/2008-04-26-bbq/CIMG1354.JPG"><img src="http://data.singularity.be/images/thumb/2008-04-26-bbq/CIMG1354.JPG.png"></a><br /><br />Attaching triangular supports to reinforce the base:<br /><a href="http://data.singularity.be/images/full/2008-04-26-bbq/CIMG1355.JPG"><img src="http://data.singularity.be/images/thumb/2008-04-26-bbq/CIMG1355.JPG.png"></a><a href="http://data.singularity.be/images/full/2008-04-26-bbq/CIMG1356.JPG"><img src="http://data.singularity.be/images/thumb/2008-04-26-bbq/CIMG1356.JPG.png"></a><br /><br />Making and attaching the closing lid of the "suitcase":<br /><a href="http://data.singularity.be/images/full/2008-04-26-bbq/CIMG1357.JPG"><img src="http://data.singularity.be/images/thumb/2008-04-26-bbq/CIMG1357.JPG.png"></a><a href="http://data.singularity.be/images/full/2008-04-26-bbq/CIMG1358.JPG"><img src="http://data.singularity.be/images/thumb/2008-04-26-bbq/CIMG1358.JPG.png"></a><a href="http://data.singularity.be/images/full/2008-04-26-bbq/CIMG1359.JPG"><img src="http://data.singularity.be/images/thumb/2008-04-26-bbq/CIMG1359.JPG.png"></a><a href="http://data.singularity.be/images/full/2008-04-26-bbq/CIMG1360.JPG"><img src="http://data.singularity.be/images/thumb/2008-04-26-bbq/CIMG1360.JPG.png"></a><br /><br />All done!<br /><br />I'm going to the hardware store tonmorrow to see what kind of materials I can use to make this, and how much it will cost.
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2008/04/25/wwwkuloketbe/">
        www.kuloket.be
      </a>
    </h1>

    <span class="post-date">25 Apr 2008</span>

    <!-- StevensBlogSpotFilterThing<br />KULoket is de webtoegang tot SAP voor KULeuven personeel en studenten. Het is rechtstreeks bereikbaar via <a href="https://webwsp.aps.kuleuven.be/irj/portal">https://webwsp.aps.kuleuven.be/irj/portal</a> voor diegenen die zich dat makkelijk kunnen herinneren (dat ben ik dus niet).<br /><br />Om KULoket terug te vinden op de KULeuven website ga je naar <a href="http://www.kuleuven.be">http://www.kuleuven.be</a>. Vandaar heb je 2 keuzes: ofwel klik je op "Intranet" waarvoor je moet inloggen en vervolgens op "KULoket", alwaar je weeral moet inloggen met dezelfde credentials. Of, je klikt op "Faciliteiten" en dan helemaal onderaan de pagina op "KULoket".<br /><br />Allemaal veel te rommelig voor mij. Ik heb onlangs het "kuloket.be" domein geregistreerd en laten verwijzen naar KULoket. Volgende URLs werken zeker al:<br /><br /><a href="http://kuloket.be">http://kuloket.be</a><br><br /><a href="http://www.kuloket.be">http://www.kuloket.be</a><br /><br />Er is ook <a href="http://verlof.kuloket.be">http://verlof.kuloket.be</a>, maar dat werkt enkel als je al op KULoket bent ingelogd. Die beperking komt door KULoket zelf...<br /><br />De voorbije dagen is er precies al wat heisa geweest over het feit dat ik dat domein geregistreerd heb. Ik heb echter nog aan niemand moeten beloven dat ik er geen kattekwaad mee mag uithalen :)<br /><br /><br />StevensBlogSpotFilterThing --><br />KULoket is de webtoegang tot SAP voor KULeuven personeel en studenten. Het is rechtstreeks bereikbaar via <a href="https://webwsp.aps.kuleuven.be/irj/portal">https://webwsp.aps.kuleuven.be/irj/portal</a> voor diegenen die zich dat makkelijk kunnen herinneren (dat ben ik dus niet).<br /><br />Om KULoket terug te vinden op de KULeuven website ga je naar <a href="http://www.kuleuven.be">http://www.kuleuven.be</a>. Vandaar heb je 2 keuzes: ofwel klik je op "Intranet" waarvoor je moet inloggen en vervolgens op "KULoket", alwaar je weeral moet inloggen met dezelfde credentials. Of, je klikt op "Faciliteiten" en dan helemaal onderaan de pagina op "KULoket".<br /><br />Allemaal veel te rommelig voor mij. Ik heb onlangs het "kuloket.be" domein geregistreerd en laten verwijzen naar KULoket. Volgende URLs werken zeker al:<br /><br /><a href="http://kuloket.be">http://kuloket.be</a><br><br /><a href="http://www.kuloket.be">http://www.kuloket.be</a><br /><br />Er is ook <a href="http://verlof.kuloket.be">http://verlof.kuloket.be</a>, maar dat werkt enkel als je al op KULoket bent ingelogd. Die beperking komt door KULoket zelf...<br /><br />De voorbije dagen is er precies al wat heisa geweest over het feit dat ik dat domein geregistreerd heb. Ik heb echter nog aan niemand moeten beloven dat ik er geen kattekwaad mee mag uithalen :)
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2008/04/24/maximum-size-of-isa-server-nlb-cluster/">
        Maximum size of an ISA Server NLB Cluster
      </a>
    </h1>

    <span class="post-date">24 Apr 2008</span>

    <!-- StevensBlogSpotFilterThing<br />This is a long and technical post about why Microsoft recommends that there be no more than 8 nodes in an ISA NLB cluster. There are some nice pictures of graphs and a summary at the bottom if you want to skim through it :)<br /><br /><b>8, 12 or 32 nodes?</b><br />There is some confusion as to how many nodes can be in an ISA NLB cluster. Digging around on the internet doesn't really solve the problem:<br /><br /><quote>"... However, it requires some CPU processing overhead (about 10 to 15 percent for common ISA Server scenarios), and has a limit to the number of members in the cluster. (<b>About 12 machines is the recommended maximum</b>.) ..."</quote><br />(<a href="http://www.microsoft.com/technet/archive/security/prodtech/isa/isaprfbp.mspx?mfr=true">http://www.microsoft.com/technet/archive/security/prodtech/isa/isaprfbp.mspx?mfr=true</a>)<br /><br /><quote>"... However, it requires CPU processing overhead (approximately 10 to 15 percent for common ISA Server scenarios), and has a limit to the number of members in the cluster (<b>approximately 8 computers as the recommended maximum</b>). ..."</quote><br />(<a href="http://www.microsoft.com/technet/isa/2006/perf_bp.mspx">http://www.microsoft.com/technet/isa/2006/perf_bp.mspx</a>)<br /><br /><quote>"... Cluster size, defined as the number of cluster hosts participating in the cluster (<b>up to 32</b>), is based on the number of computers required to meet the anticipated client load for a given application. ..."</quote><br />(<a href="http://technet2.microsoft.com/windowsserver/en/library/750d3a40-af67-411d-828b-fc1f718a06fb1033.mspx?mfr=true">http://technet2.microsoft.com/windowsserver/en/library/750d3a40-af67-411d-828b-fc1f718a06fb1033.mspx?mfr=true</a>)<br /><br /><quote>"... Network Load Balancing clusters provide scalability and high availability for TCP- and UDP-based services and applications by combining <b>up to 32 servers</b> running Windows Server 2003 ..."</quote><br />(<a href="http://technet2.microsoft.com/windowsserver/en/library/358b9815-3cd3-4912-a75a-cae85ea8d5ab1033.mspx?mfr=true">http://technet2.microsoft.com/windowsserver/en/library/358b9815-3cd3-4912-a75a-cae85ea8d5ab1033.mspx?mfr=true</a>)<br /><br />It is a common believe (myth?) that ISA performance will degrade drastically when more than 8 nodes are in a single cluster. <br /><br /><b>But why is this important ?</b><br /><br />Our university has about 7000 employees who will all be using Microsoft Exchange within a year (...). Using the <a href="http://www.microsoft.com/isaserver/capacityplanner.swf">ISA capacity planner</a>, we calculated that we would need close to 8 ISA servers in a cluster to accomodate this amount of users. And that's where the Microsoft recommendation comes into play.<br /><br />Because 8 ISA servers in an NLB cluster is supposedly bad for performance, 2 solutions were offered. First, we could place a hardware loadbalancer like F5 or Alteon which (again supposedly) costs a fortune. Second, we could increase the complexity of our setup and pull some traffic from the ISA cluster by allowing direct Outlook Anywhere connections from clients that are inside the domain, using a combination of fingercrossinng and something we have affectionately called "Silly DNS".<br /><br />Of course, I prefer neither solution because I believe an ISA NLB cluster can work perfectly with more than 8 nodes. I have spent the better part of today trying to dig up information on this circus and will now attempt to "prove" that ISA can do much better than what is generally believed. Of course, the best test would be a setup with 32 physical ISA servers in a single cluster. But I don't own that much hardware, not to mention the cost of the electric bill...<br /><br />Allright, let's first look at how NLB works and why I doubt it would have a performance impact on ISA.<br /><br /><b>How NLB works</b><br />NLB is short for Network Load Balancing. It has 2 variants: unicast and multicast. I will only consider unicast because that's the simplest.<br /><br />When N servers are in a unicast NLB cluster, they all listen for the same IP address and MAC address on the same network. So when a router transmits something to that IP address, all N cluster nodes receive it. Now instead of all of the nodes handling the incoming packet in parallel, only 1 should do so. A single node is "selected" to handle the packet and all other nodes drop the received packet.<br /><br />So that's basically how it works. N nodes all receive the same traffic, but only 1 of them actually handles a specific incoming packet. Instead of a central instance telling a node that it should handle that packet, the nodes actually know themselves by using a fully distributed hashing algorithm. The way I understand this is that each node has a unique ID (from 0 to N-1). When a packet comes in, they all perform a hashing calculation (like modulo N) on a combination of source IP and source port (depending on the affinity setting). If the result is the ID of the node, then that node handles the packet.<br /><br />Such an algorithm would work great if the number of nodes were fixed and none of them ever failed. But this is planet Earth and failure is always a possibility.<br /><br />In case a node fails, is removed or added to the cluster, a process called NLB cluster convergence is started. Conceptually, this means that all existing nodes yell "I'm alive" on the network, everyone counts the number of active nodes and "gets assigned" a unique ID number. When that's done, the cluster is said to have converged and can go on handling traffic.<br /><br />To detect that a node has failed, "Alive" messages are sent over the network at a certain interval. If a certain node doesn't send an alive message for some amount of time, a convergence process is started.<br /><br />There is some <a href="http://207.46.196.114/windowsserver/en/library/9273cc42-f263-4421-a637-13f1f8c04d971033.mspx?mfr=true">information about NLB registry settings</a>, among which are AliveMsgPeriod and AliveMsgTolerance.<br /><br />The default settings are 1000 (1 second) for AliveMsgPeriod and 5 for AliveMsgTolerance. This means that all nodes broadcast alive messages every second, and a node is considered dead after having failed to transmit 5 such messages (so 5 seconds).<br /><br />More information needed ? <a href="http://207.46.196.114/windowsserver/en/library/1611cae3-5865-4897-a186-7e6ebd8855cb1033.mspx?mfr=true">How Network Load Balancing Technology Works</a><br /><br /><b>Why NLB shouldn't affect ISA performance</b><br /><br />Let's analyze this algorithm and see if it can affect ISA performance in any significant way.<br /><br />I'm assuming a setup where each ISA server has a separate networkcard for sending Alive messages (hereby called the heartbeat network). This is exactly the setup we use: 1 External, 1 Internal and 1 HB network interface. <br /><br />Furthermore, I assume that all interfaces are gigabit and connected to separate switches (1 for External, 1 for Internal and 1 for HB)<br /><br />Right, let's first go for default behaviour. <br /><br />If there are 10 NLB nodes, all 10 will receive the same data. If that saturates the link attached to the External NIC, then the total throughput to the ISA cluster is 1 gigabit, independent of the amount of NLB nodes in the cluster (assuming the switch has a well enough switching fabric)<br /><br />Similarly, on the Internal side, all links can be saturated at once. The bottleneck will then be either the switch or the backend, but not the ISA cluster.<br /><br />Now for the special behaviour: the alive messages.<br /><br />Every second, every node sends a broadcast message to indicate that it is still alive.<br />For some odd reason, they are all 1510 bytes big, no matter what the content is. Sending these messages to the HB switch can happen all at once, but then the switch needs to serialize all those messages to broadcast them. Every second, the HB switch has N messages of 1510 bytes long that it needs to send over each link. <br />In case of 32 NLB nodes, that would be about 48KB/s. Clearly this is within the capability of a gigabit link. In fact, to fully saturate a gigabit link with alive messages, there would need to be more than 650000 nodes in the NLB cluster.<br /><br />So, which part of this entire construction is having an impact on the ISA performance ? Whether there is only 1 node or 500 nodes in the cluster, conceptually it would make no real difference.<br /><br />I forgot to mention 2 things: NLB clusters are limited to 32 hosts for some reason. And using NLB on a node has a 15% performance penalty on the node, even if it is the only node in the cluster. I'm stunned :) I really don't understand how this can happen.<br /><br />But then, I don't know if this is exactly how NLB operates. It's just the way I would have designed it.<br /><br /><b>What does the capacity planner say ?</b><br /><br />Microsoft released some <a href="http://www.microsoft.com/technet/isa/2006/perf_bp.mspx">performance best practices</a> that were turned into a <a href="http://www.microsoft.com/isaserver/capacityplanner.swf">capacity planner</a> by Thomas Shinder. The bad news is that the capacity planner there is a flash program. The good nenws is that there is also <a href="http://www.isascripts.org/scripts.zip">a spreadsheet version</a> of the same program.<br /><br />This flash version of the capacity planner was used to determine that we will need close to 8 servers if all traffic goes through the ISA cluster. I don't doubt that.<br /><br />What I was curious about, is how this tool calculates its result. The page with the performance best practices is a good and interesting read. The most relevant part of the data can be found at the bottom of that page:<br /><br />[FULLIMG:http://data.singularity.be/images/full/2008-04-24-isa/nlb_array_scale_factors.png]<br /><br />You'll notice that the capacity planner can't handle more than 8 servers because Microsoft did not specify the data for more than 8 NLB nodes in this document. This causes me to believe that it is a myth that performance will degrade drastically if there are more than 8 nodes.<br /><br />Where did Microsoft come up with these numbers ? I don't know. Let's have a look:<br />[FULLIMG:http://data.singularity.be/images/full/2008-04-24-isa/graph_8_scalefactors.png]<br /><br />The good observer will notice that these numbers are slightly bent downwards like a logarithmic curve. Using a <a href="http://www.xuru.org/rt/NLR.asp">nonlinear regression tool</a> I was able to calculate that the scalefactors can be calculated as:<br /><pre><br />scalefactor = n^0.1927<br /></pre><br /><br />Where n is the amount of nodes.<br /><br />This results in the following data:<br />[FULLIMG:http://data.singularity.be/images/full/2008-04-24-isa/graph_32_scalefactors.png]<br /><br />I then adapted the capacity planner spreadsheet and added those scalefactors. You can download it here:<br /><br />[DOWNLOAD:http://data.singularity.be/Trashcan/ISA_Array_Sizing_Spreadsheet_on_steroids.xls]<br /><br />The spreadsheet shows that the speed of each CPU of each node keeps decreasing as the cluster gets larger (which was to be expected) and that there is no special "butter zone" around 8 nodes per cluster.<br /><br /><b>Summary</b><br />Microsoft recommends that there not be more than 8 nodes per ISA NLB cluster, while an NLB cluster can technically have up to 32 nodes in it. I showed that the NLB algorithm itself does not limit the amount of nodes in the cluster. Furthermore, I believe that the numbers from the performance best practices can be extrapolated for up to 32 nodes and I updated the capacity planner spreadsheet accordingly.<br /><br />Maybe there is some good reason for keeping the size of an NLB cluster limited to 8, but I have not found it. If Microsofts recommendation of maximum 8 nodes is all that stands in the way to save several 10s of thousands of euros or a simpler setup, then I will gladly dismiss it.<br />If there is a good reason however, I will want to hear it. I'll see if I can get hold of someone with a good answer.<br /><br /><br /><br /><br /><br />StevensBlogSpotFilterThing --><br />This is a long and technical post about why Microsoft recommends that there be no more than 8 nodes in an ISA NLB cluster. There are some nice pictures of graphs and a summary at the bottom if you want to skim through it :)<br /><br /><b>8, 12 or 32 nodes?</b><br />There is some confusion as to how many nodes can be in an ISA NLB cluster. Digging around on the internet doesn't really solve the problem:<br /><br /><quote>"... However, it requires some CPU processing overhead (about 10 to 15 percent for common ISA Server scenarios), and has a limit to the number of members in the cluster. (<b>About 12 machines is the recommended maximum</b>.) ..."</quote><br />(<a href="http://www.microsoft.com/technet/archive/security/prodtech/isa/isaprfbp.mspx?mfr=true">http://www.microsoft.com/technet/archive/security/prodtech/isa/isaprfbp.mspx?mfr=true</a>)<br /><br /><quote>"... However, it requires CPU processing overhead (approximately 10 to 15 percent for common ISA Server scenarios), and has a limit to the number of members in the cluster (<b>approximately 8 computers as the recommended maximum</b>). ..."</quote><br />(<a href="http://www.microsoft.com/technet/isa/2006/perf_bp.mspx">http://www.microsoft.com/technet/isa/2006/perf_bp.mspx</a>)<br /><br /><quote>"... Cluster size, defined as the number of cluster hosts participating in the cluster (<b>up to 32</b>), is based on the number of computers required to meet the anticipated client load for a given application. ..."</quote><br />(<a href="http://technet2.microsoft.com/windowsserver/en/library/750d3a40-af67-411d-828b-fc1f718a06fb1033.mspx?mfr=true">http://technet2.microsoft.com/windowsserver/en/library/750d3a40-af67-411d-828b-fc1f718a06fb1033.mspx?mfr=true</a>)<br /><br /><quote>"... Network Load Balancing clusters provide scalability and high availability for TCP- and UDP-based services and applications by combining <b>up to 32 servers</b> running Windows Server 2003 ..."</quote><br />(<a href="http://technet2.microsoft.com/windowsserver/en/library/358b9815-3cd3-4912-a75a-cae85ea8d5ab1033.mspx?mfr=true">http://technet2.microsoft.com/windowsserver/en/library/358b9815-3cd3-4912-a75a-cae85ea8d5ab1033.mspx?mfr=true</a>)<br /><br />It is a common believe (myth?) that ISA performance will degrade drastically when more than 8 nodes are in a single cluster. <br /><br /><b>But why is this important ?</b><br /><br />Our university has about 7000 employees who will all be using Microsoft Exchange within a year (...). Using the <a href="http://www.microsoft.com/isaserver/capacityplanner.swf">ISA capacity planner</a>, we calculated that we would need close to 8 ISA servers in a cluster to accomodate this amount of users. And that's where the Microsoft recommendation comes into play.<br /><br />Because 8 ISA servers in an NLB cluster is supposedly bad for performance, 2 solutions were offered. First, we could place a hardware loadbalancer like F5 or Alteon which (again supposedly) costs a fortune. Second, we could increase the complexity of our setup and pull some traffic from the ISA cluster by allowing direct Outlook Anywhere connections from clients that are inside the domain, using a combination of fingercrossinng and something we have affectionately called "Silly DNS".<br /><br />Of course, I prefer neither solution because I believe an ISA NLB cluster can work perfectly with more than 8 nodes. I have spent the better part of today trying to dig up information on this circus and will now attempt to "prove" that ISA can do much better than what is generally believed. Of course, the best test would be a setup with 32 physical ISA servers in a single cluster. But I don't own that much hardware, not to mention the cost of the electric bill...<br /><br />Allright, let's first look at how NLB works and why I doubt it would have a performance impact on ISA.<br /><br /><b>How NLB works</b><br />NLB is short for Network Load Balancing. It has 2 variants: unicast and multicast. I will only consider unicast because that's the simplest.<br /><br />When N servers are in a unicast NLB cluster, they all listen for the same IP address and MAC address on the same network. So when a router transmits something to that IP address, all N cluster nodes receive it. Now instead of all of the nodes handling the incoming packet in parallel, only 1 should do so. A single node is "selected" to handle the packet and all other nodes drop the received packet.<br /><br />So that's basically how it works. N nodes all receive the same traffic, but only 1 of them actually handles a specific incoming packet. Instead of a central instance telling a node that it should handle that packet, the nodes actually know themselves by using a fully distributed hashing algorithm. The way I understand this is that each node has a unique ID (from 0 to N-1). When a packet comes in, they all perform a hashing calculation (like modulo N) on a combination of source IP and source port (depending on the affinity setting). If the result is the ID of the node, then that node handles the packet.<br /><br />Such an algorithm would work great if the number of nodes were fixed and none of them ever failed. But this is planet Earth and failure is always a possibility.<br /><br />In case a node fails, is removed or added to the cluster, a process called NLB cluster convergence is started. Conceptually, this means that all existing nodes yell "I'm alive" on the network, everyone counts the number of active nodes and "gets assigned" a unique ID number. When that's done, the cluster is said to have converged and can go on handling traffic.<br /><br />To detect that a node has failed, "Alive" messages are sent over the network at a certain interval. If a certain node doesn't send an alive message for some amount of time, a convergence process is started.<br /><br />There is some <a href="http://207.46.196.114/windowsserver/en/library/9273cc42-f263-4421-a637-13f1f8c04d971033.mspx?mfr=true">information about NLB registry settings</a>, among which are AliveMsgPeriod and AliveMsgTolerance.<br /><br />The default settings are 1000 (1 second) for AliveMsgPeriod and 5 for AliveMsgTolerance. This means that all nodes broadcast alive messages every second, and a node is considered dead after having failed to transmit 5 such messages (so 5 seconds).<br /><br />More information needed ? <a href="http://207.46.196.114/windowsserver/en/library/1611cae3-5865-4897-a186-7e6ebd8855cb1033.mspx?mfr=true">How Network Load Balancing Technology Works</a><br /><br /><b>Why NLB shouldn't affect ISA performance</b><br /><br />Let's analyze this algorithm and see if it can affect ISA performance in any significant way.<br /><br />I'm assuming a setup where each ISA server has a separate networkcard for sending Alive messages (hereby called the heartbeat network). This is exactly the setup we use: 1 External, 1 Internal and 1 HB network interface. <br /><br />Furthermore, I assume that all interfaces are gigabit and connected to separate switches (1 for External, 1 for Internal and 1 for HB)<br /><br />Right, let's first go for default behaviour. <br /><br />If there are 10 NLB nodes, all 10 will receive the same data. If that saturates the link attached to the External NIC, then the total throughput to the ISA cluster is 1 gigabit, independent of the amount of NLB nodes in the cluster (assuming the switch has a well enough switching fabric)<br /><br />Similarly, on the Internal side, all links can be saturated at once. The bottleneck will then be either the switch or the backend, but not the ISA cluster.<br /><br />Now for the special behaviour: the alive messages.<br /><br />Every second, every node sends a broadcast message to indicate that it is still alive.<br />For some odd reason, they are all 1510 bytes big, no matter what the content is. Sending these messages to the HB switch can happen all at once, but then the switch needs to serialize all those messages to broadcast them. Every second, the HB switch has N messages of 1510 bytes long that it needs to send over each link. <br />In case of 32 NLB nodes, that would be about 48KB/s. Clearly this is within the capability of a gigabit link. In fact, to fully saturate a gigabit link with alive messages, there would need to be more than 650000 nodes in the NLB cluster.<br /><br />So, which part of this entire construction is having an impact on the ISA performance ? Whether there is only 1 node or 500 nodes in the cluster, conceptually it would make no real difference.<br /><br />I forgot to mention 2 things: NLB clusters are limited to 32 hosts for some reason. And using NLB on a node has a 15% performance penalty on the node, even if it is the only node in the cluster. I'm stunned :) I really don't understand how this can happen.<br /><br />But then, I don't know if this is exactly how NLB operates. It's just the way I would have designed it.<br /><br /><b>What does the capacity planner say ?</b><br /><br />Microsoft released some <a href="http://www.microsoft.com/technet/isa/2006/perf_bp.mspx">performance best practices</a> that were turned into a <a href="http://www.microsoft.com/isaserver/capacityplanner.swf">capacity planner</a> by Thomas Shinder. The bad news is that the capacity planner there is a flash program. The good nenws is that there is also <a href="http://www.isascripts.org/scripts.zip">a spreadsheet version</a> of the same program.<br /><br />This flash version of the capacity planner was used to determine that we will need close to 8 servers if all traffic goes through the ISA cluster. I don't doubt that.<br /><br />What I was curious about, is how this tool calculates its result. The page with the performance best practices is a good and interesting read. The most relevant part of the data can be found at the bottom of that page:<br /><br /><a href="http://data.singularity.be/images/full/2008-04-24-isa/nlb_array_scale_factors.png"><img src="http://data.singularity.be/images/full/2008-04-24-isa/nlb_array_scale_factors.png"></a><br /><br />You'll notice that the capacity planner can't handle more than 8 servers because Microsoft did not specify the data for more than 8 NLB nodes in this document. This causes me to believe that it is a myth that performance will degrade drastically if there are more than 8 nodes.<br /><br />Where did Microsoft come up with these numbers ? I don't know. Let's have a look:<br /><a href="http://data.singularity.be/images/full/2008-04-24-isa/graph_8_scalefactors.png"><img src="http://data.singularity.be/images/full/2008-04-24-isa/graph_8_scalefactors.png"></a><br /><br />The good observer will notice that these numbers are slightly bent downwards like a logarithmic curve. Using a <a href="http://www.xuru.org/rt/NLR.asp">nonlinear regression tool</a> I was able to calculate that the scalefactors can be calculated as:<br /><pre><br />scalefactor = n^0.1927<br /></pre><br /><br />Where n is the amount of nodes.<br /><br />This results in the following data:<br /><a href="http://data.singularity.be/images/full/2008-04-24-isa/graph_32_scalefactors.png"><img src="http://data.singularity.be/images/full/2008-04-24-isa/graph_32_scalefactors.png"></a><br /><br />I then adapted the capacity planner spreadsheet and added those scalefactors. You can download it here:<br /><br /><div style="padding: 2px; background-color: #f0f0f0;"><a href="http://data.singularity.be/Trashcan/ISA_Array_Sizing_Spreadsheet_on_steroids.xls"><img style="vertical-align: middle; padding: 2px;" src="http://data.singularity.be/images/icon/download-icon.png">Download http://data.singularity.be/Trashcan/ISA_Array_Sizing_Spreadsheet_on_steroids.xls</a></div><br /><br />The spreadsheet shows that the speed of each CPU of each node keeps decreasing as the cluster gets larger (which was to be expected) and that there is no special "butter zone" around 8 nodes per cluster.<br /><br /><b>Summary</b><br />Microsoft recommends that there not be more than 8 nodes per ISA NLB cluster, while an NLB cluster can technically have up to 32 nodes in it. I showed that the NLB algorithm itself does not limit the amount of nodes in the cluster. Furthermore, I believe that the numbers from the performance best practices can be extrapolated for up to 32 nodes and I updated the capacity planner spreadsheet accordingly.<br /><br />Maybe there is some good reason for keeping the size of an NLB cluster limited to 8, but I have not found it. If Microsofts recommendation of maximum 8 nodes is all that stands in the way to save several 10s of thousands of euros or a simpler setup, then I will gladly dismiss it.<br />If there is a good reason however, I will want to hear it. I'll see if I can get hold of someone with a good answer.
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2008/04/24/insulting-source-code/">
        Insulting source code
      </a>
    </h1>

    <span class="post-date">24 Apr 2008</span>

    <!-- StevensBlogSpotFilterThing<br />This is why you don't piss off software maintainers :)<br /><br /><a href="http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=477454">http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=477454</a><br /><br /><pre><br />--- player.py (Revision 4026)<br />+++ player.py (Revision 4027)<br />@@ -287,7 +287,9 @@<br /><br /> def init(pipeline, librarian):<br />     gst.debug_set_default_threshold(gst.LEVEL_ERROR)<br />- if gst.element_make_from_uri(gst.URI_SRC, "file://", ""):<br />+ if gst.element_make_from_uri(<br />+ gst.URI_SRC,<br />+ "file:///Sebastian/Droge/please/choke/on/a/bucket/of/cocks", ""):<br />         global playlist<br />         playlist = PlaylistPlayer(pipeline or "gconfaudiosink",<br />librarian)<br />         return playlist<br /></pre><br /><br />StevensBlogSpotFilterThing --><br />This is why you don't piss off software maintainers :)<br /><br /><a href="http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=477454">http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=477454</a><br /><br /><pre><br />--- player.py (Revision 4026)<br />+++ player.py (Revision 4027)<br />@@ -287,7 +287,9 @@<br /><br /> def init(pipeline, librarian):<br />     gst.debug_set_default_threshold(gst.LEVEL_ERROR)<br />- if gst.element_make_from_uri(gst.URI_SRC, "file://", ""):<br />+ if gst.element_make_from_uri(<br />+ gst.URI_SRC,<br />+ "file:///Sebastian/Droge/please/choke/on/a/bucket/of/cocks", ""):<br />         global playlist<br />         playlist = PlaylistPlayer(pipeline or "gconfaudiosink",<br />librarian)<br />         return playlist<br /></pre>
  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page22">Older</a>
  
  
    
      <a class="pagination-item newer" href="/page20">Newer</a>
    
  
</div>

    </div>

  </body>
</html>
