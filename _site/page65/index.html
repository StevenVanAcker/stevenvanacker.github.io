<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Singularity.be &middot; Flawed logic inspecting flawed logic
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Singularity.be
        </a>
      </h1>
      <p class="lead">Steven Van Acker's blog</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">About</a>
          
        
      
        
          
        
      
        
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/projects/">Projects</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/publications/">Publications</a>
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
    </nav>

    <!-- <p>&copy; 2016. All rights reserved.</p> -->
  </div>
</div>


    <div class="content container">
      <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2007/02/16/shaving-cpu-cycles/">
        shaving CPU-cycles
      </a>
    </h1>

    <span class="post-date">16 Feb 2007</span>

    I've been reading up on how to benchmark firewalls and netfilter in particular.<br />At first, I came across <a href="http://www.faqs.org/rfcs/rfc2647.html">RFC 2647: Benchmarking Terminology for Firewall Performance</a> which, after reading through it, did not help me much at all. I already know the thing to watch is the throughput in packets per second...<br /><br />Next I came across a <a href="http://people.netfilter.org/kadlec/nftest.pdf">benchmark performed on Netfilter, NF-HiPAC and ipset</a>. I already saw this one before when I was looking for alternatives to NF-HiPAC. The paper makes it appear as if ipset performs equally well to NF-HiPAC, but it's a scam (a scam I tell you! ;)<br /><br />IPset is nothing more than a datastructure for storing a bunch of IP addresses in. The netfilter match will then check whether an IP address is in that set or not. In itself, not a bad thing to have since we can easily implement early reject rules with this. But to compare it to NF-HiPAC... The test shows that ipset is so great because... the test seems to have been designed specifically for ipset.<br /><br />To quote from the paper:<br /><pre><br />The systems were tested using the equivalent of the following pseudo-rules:<br /><br />  -m state --­­state ESTABLISHED,RELATED -­j ACCEPT<br />  < N non­matching IP address rule >­<br />  -p tcp --­­dport 80 ­-m state --­­state NEW -­j ACCEPT<br /><br />where N started at 16 and doubled until we reached 16384 non-matching rules. (In order to test the worst case, iphash type of set was used in the ipset tests.)<br /></pre><br /><br />This shows of course nothing useful, except that ipset is good at storing and checking IP-addresses against a pile of other IP-addresses.<br /><br />So anyway, what did I do ?<br />I went through my code and located the single function that gets called a lot when doing a query (actually, the *only* function that gets called): tree_query<br />Since it has only 1 loop to decend down the tree, and not much is done inside the loop except decide which branch to go into next, there was not much to optimise.<br /><br />Still, I managed to shave off a couple CPU cycles by replacing this line:<br /><pre><br />  branch = !!(ip & (1 << (31 - currentRoot->cidr)));<br /></pre><br />with<br /><pre><br />  branch = (ip & (~CIDR2MASK(currentRoot->cidr) & CIDR2MASK(currentRoot->cidr + 1))) > 0;<br /></pre><br /><br />currentRoot->cidr is the CIDR netmask number of the node we're currently in. (This means that the first [cidr] amount of bits are constant in the IP address) The next branch to decend into in this binary tree is either left or right. It is decided by the next bit in the IP-address, or the [cidr+1]'th bit. The value of this bit it stored in [branch]<br /><br />By optimising like this, I get an average of 9.60 seconds instead of 9.67 seconds to classify 40 million IP addresses.<br /><br />Not that much, but it gives me about 30000 more classifications per second.<br /><br />[Update 10 minutes later]<br />Hah! OK, I made a mistake...<br />I forgot some braces which resulted in wrong code (operator order and that stuff). It seems the new code now takes 9.73 seconds for 40 million classifications, so I guess I'd better stay with the old...<br /><br />[Update 1 minute later]<br />I'm on a roll I think...<br /><br />After thinking about what I was actually trying to do, I replaced the line with this<br /><pre><br />branch = (ip >> (31 - currentRoot->cidr)) & 1;<br /></pre><br /><br />The runtime is now 9.38 seconds, which is actually about 0.3 seconds better. Resulting in about 130000 extra classifications per second!<br /><br />Yay for me !<br /><br />[Update 5 minutes later]<br />After some code cleanup, removing unneeded variables and renaming/reusing some, I shaved another 0.1 seconds off for a total runtime of 9.27 seconds on 40 million classifications. 180000 extra classifications per second !
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2007/02/15/mohammed-bouazza/">
        Mohammed Bouazza
      </a>
    </h1>

    <span class="post-date">15 Feb 2007</span>

    Ik heb hier zojuist een artikel gelezen in de Humo over de gebeurtenissen die leiden tot de dood van Mohammed Bouazza.<br /><br />Blijkbaar was er in de nacht van 30 april op 1 mei een of ander incident waardoor Mohammed bedreigd werd door wat Belgen en toen weggevlucht is en in de Schelde is terechtgekomen.<br />Dat die Belgen Mohammed bedreigd hebben bewijst nog maar eens hoe tolerant we wel zijn in ons Belgenlandje...<br />Maar los daarvan: de politie werd op de hoogte gebracht dat er iemand in de Schelde gevallen was en die deden niks. Pas op 9 mei en nadat de zaak ge-escaleerd was naar de federale politie, werd er een zoekactie gestart en hebben ze zijn lichaam uit de Schelde opgevist. Uit meerdere getuigenissen blijkt dat de politie van Antwerpen hier zeer onbeschoft en onbehulpzaam geweest is. Ik vind dit een regelrechte schande. Als ze iets hadden gedaan was er een mensenleven gespaard geweest.<br /><br />Beste burgemeester Janssens, misschien kunt ge is met een lange stok in uw politie-kot stoken en onderzoeken vanwaar die onwil komt ?<br />In Amerika staat er op elke politiewagen (volgens Hollywood) "To serve and protect". Wel, leer daar eens iets van. "To serve" betekent "Om te dienen" en "protect" betekent beschermen. Aan de kant van de Schelde staan terwijl er iemand verdrinkt en een getuige wegsturen omdat het middagpauze is, dat is niet ten dienste zijn van burgers. Mensen lastigvallen door elke 5 botten hun papieren te controleren en mensen bedreigen als ze getuigen, dat is niet ten dienste staan van burgers. En dan zwijg ik nog over het gedeelte waarin ze burgers moeten beschermen...<br /><br />Nog enkele links:<br />http://www.indymedia.be/en/node/2462/1328<br />http://www.site.kifkif.be/forum/showthread.php?t=2813
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2007/02/15/nieuwe-auto/">
        nieuwe auto !
      </a>
    </h1>

    <span class="post-date">15 Feb 2007</span>

    Ik ben al een week of 2 op zoek naar ne nieuwe auto. Vereisten: klein, goedkoop en moet nog lang meegaan.<br /><br />Mijn budget lag op 5000 euro. Vorige week had ik een Renault Twingo gezien in Halle voor 4950 euro. Bouwjaar 2003, 49000km. Dat zag er mij iets uit, behalve dat het dan in Halle was want daar geraak ik niet met de fiets.<br /><br />Gisteren surf ik langs http://www.easyauto.be en zoek ik naar alle Renault Twingo's die ze hebben met bouwjaar tussen 2003 en 2007, om te kunnen vergelijken. En wat zie ik daar nu staan ? Een Renault Twingo (1200cc benzine "1.2 HELIOS OPEN AIR ") van 29 december 2003 (infeite dus begin 2004), 27000km in Herent vlak bij Leuven. Gisteravond daar dus naartoe met Noot en Nele, vlak voor sluitingtijd.<br />Auto blijkt 75PK (volgens Noot iets van een 7 fiscale PK) te hebben en ongeveer 5l/100km te verbruiken.<br /><br />Die auto blijkt een erfenis te zijn uit een sterfgeval...<br /><br />De lijst met eigenschappen: Metaalkleur, 1ste eigenaar, Onderhoudsboekje, Sidebags, Airbags, Alarminstallatie, Radio-CD, Schuifdak, Achterbank 1/3 - 2/3, Centr. Vergrendeling, Mistlichten, Neerklapbare Achterbank, Elektrische ruiten, Servo, ABS, Elektrische spiegels, Getinte ruiten, Luidsprekers<br /><br />En zo ziet hij eruit:<br />[G2:10989]<br />(http://www.easyauto.be/X_autozoekertjes_detail.asp?action=show&id=799682)<br /><br />Volgens <a href="http://www.autogids.be/cote.cfm?xmarqueid=690&xoldmarqueid=690&xmodelegen=Twingo&xoldmodelegen=">http://www.autogids.be/</a> is de richtprijs voor die wagen nu 6256 of 5537 euro (voor bouwjaar 2004 of 2003 respectievelijk)<br /><br />De prijs zit dus zowieso goed. Er is dan nog is een jaar garantie op ook en de garagist ziet er betrouwbaar uit.<br /><br />Ik heb die auto dus gekocht! :) Volgende week kan ik hem gaan ophalen en kan ik EINDELIJK beginnen rondrijden met mijn L
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2007/02/13/better-hppc-data-structure/">
        Better HPPC data-structure
      </a>
    </h1>

    <span class="post-date">13 Feb 2007</span>

    Here is what the datastructure looks like now (same dataset of 10 IP's):<br />[G2:10986]<br /><br />As you can see, most redundant nodes have been removed. Instead of creating new nodes along the way, the new algorithm tries to be smart about things and only adds new nodes when it needs to: when a node already exists in some branch, a new node is created that contains that old node and the newly added one.
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2007/02/13/weird-traffic-to-1000-port-0udp/">
        weird traffic to 1.0.0.0 port 0/udp
      </a>
    </h1>

    <span class="post-date">13 Feb 2007</span>

    I'm seeing some weird traffic to port 0/udp on 1.0.0.0. Finding anything on google is tricky.<br />I have tracked down this paper on Bogons though:<br /><br />https://noc.sara.nl/nrg/presentations/RoN-Autumn-Meeting-2006-Bogon-IP-Addresses.pdf<br /><br />Could be an interesting study :)
  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page66">Older</a>
  
  
    
      <a class="pagination-item newer" href="/page64">Newer</a>
    
  
</div>

    </div>

  </body>
</html>
