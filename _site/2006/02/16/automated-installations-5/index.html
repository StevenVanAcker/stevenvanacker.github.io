<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      automated installations (5) &middot; Singularity.be
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Singularity.be
        </a>
      </h1>
      <p class="lead">Steven Van Acker's blog</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">About</a>
          
        
      
        
          
        
      
        
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/projects/">Projects</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/publications/">Publications</a>
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
    </nav>

    <!-- <p>&copy; 2016. All rights reserved.</p> -->
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">automated installations (5)</h1>
  <span class="post-date">16 Feb 2006</span>
  I wrote 2 scripts yesterday to unpack and repack the partman-auto_41.udeb package.<br />Being able to change the code allowed me to track down the bug much faster.<br /><br />Next to the 2 scripts to unpack and pack this specific udeb, I also have 2 scripts to mount and umount the initrd (to change the preseed config file) and a s<br />cript to recreate the ISO.<br /><br />These scripts are very specific to my environment, but if you want to have a look at them and modify them to your environment, go ahead :) I'll attach them t<br />o this post.<br /><br />Now for the big news: I patched partman-auto so it works with preseed !<br />To be more precise: the bugs I found earlier were only a part of the problem. After I had changed the code to use the real free diskspace (instead of the cal<br />culated free space, rounded to MB) in the calculations, All 3 partitions were created nicely. However, partman-auto made the last partition a logical one ins<br />tead of a primary one. That made me take a closer look at the whole algorithm and I found out it ALWAYS creates an extended partition at the end of the disk.<br /><br />Why ? In short because after creating all primary partitions, it think it will need to create even more partitions for some reason (that is the bug). It then<br /> looks at the diskspace, decides it's not enough, then deletes the last partition and replaces it with an extended one. The last partition is then created ag<br />ain inside this extended partition.<br /><br />Let's look at the original code and how I patched it:<br /><pre><br />100: while<br />101:     [ "$free_type" = pri/log ] \<br />102:     && echo $scheme | grep '\$primary{' >/dev/null<br />103: do<br />104:     pull_primary<br />105:     set -- $primary<br />106:     open_dialog NEW_PARTITION primary $4 $free_space beginning ${1}000001<br />107:     read_line num id size type fs path name<br />108:     close_dialog<br />109:     if [ -z "$id" ]; then<br />110:    db_progress STOP<br />111:    autopartitioning_failed<br />112:     fi<br />113:     neighbour=$(partition_after $id)<br />114:     if [ "$neighbour" ]; then<br />115:    open_dialog PARTITION_INFO $neighbour<br />116:    read_line x1 new_free_space x2 new_free_type fs x3 x4<br />117:    close_dialog<br />118:     fi<br />119:     if <br />120:    [ -z "$neighbour" -o "$fs" != free \<br />121:      -o "$new_free_type" = primary -o "$new_free_type" = unusable ]<br />122:     then<br />123:    open_dialog DELETE_PARTITION $id<br />124:    close_dialog<br />125:    open_dialog NEW_PARTITION primary $4 $free_space end ${1}000001<br />126:    read_line num id size type fs path name<br />127:    close_dialog<br />128:    if [ -z "$id" ]; then<br />129:        db_progress STOP<br />130:        autopartitioning_failed<br />131:    fi<br />132:    neighbour=$(partition_before $id)<br />133:    if [ "$neighbour" ]; then<br />134:        open_dialog PARTITION_INFO $neighbour<br />135:        read_line x1 new_free_space x2 new_free_type fs x3 x4<br />136:        close_dialog<br />137:    fi<br />138:    if <br />139:        [ -z "$neighbour" -o "$fs" != free -o "$new_free_type" = unusable ]<br />140:    then<br />141:        open_dialog DELETE_PARTITION $id<br />142:        close_dialog<br />143:        break<br />144:    fi<br />145:     fi<br />146:     shift; shift; shift; shift<br />147:     setup_partition $id $*<br />148:     primary=''<br />149:     scheme="$logical"<br />150:     free_space=$new_free_space<br />151:     free_type="$new_free_type"<br />152: done<br />153: <br />154: db_progress STEP 1<br />155: <br />156: foreach_partition '<br />157:     if [ -z "$free_space" ]; then<br />158:         db_progress STOP<br />159:    autopartitioning_failed<br />160:     fi<br />161:     open_dialog PARTITION_INFO $free_space<br />162:     read_line x1 free_space x2 free_type fs x3 x4<br />163:     close_dialog<br />164:     if [ "$fs" != free ]; then<br />165:         free_type=unusable<br />166:     fi<br />167:     case "$free_type" in<br />168:    primary|logical)<br />169:        type="$free_type"<br />170:        ;;<br />171:    pri/log)<br />172:        type=logical<br />173:        ;;<br />174:    unusable)<br />175:             db_progress STOP<br />176:        autopartitioning_failed<br />177:        ;;<br />178:     esac<br />179:     if [ "$last" = yes ]; then<br />180:         open_dialog NEW_PARTITION $type $4 $free_space full ${1}000001<br />181:     else<br />182:         open_dialog NEW_PARTITION $type $4 $free_space beginning ${1}000001<br />183:     fi<br />184:     read_line num id size type fs path name<br />185:     close_dialog<br />186:     if [ -z "$id" ]; then<br />187:         db_progress STOP<br />188:    autopartitioning_failed<br />189:     fi<br />190:     shift; shift; shift; shift<br />191:     setup_partition $id $*<br />192:     free_space=$(partition_after $id)'<br /></pre><br /><br />This time I added nice linenumbers (grep -n "" file) ;)<br /><br />The first while-loop (from 100-152) is where the primary partitions are created.<br />If you don't look at the code between line 120 and 144, the code seems pretty obvious: for every primary partition, create the partition. If there is not eno<br />ugh space, complain and exit.<br />The check that happens on 120-121 tests whether there is some free usable space left.<br />If the check is true (meaning there is no space left), then the script REMOVES the last partition and creates a new extended partition.<br />But this check WILL fail when 3 primary partitions are created, because no space will be left after that.<br /><br />I patched the code in a number of different ways. First, instead of relying on the calculated free diskspace, I recalculate the real free disk space after ea<br />ch partition is added. Next, when a partition wants to be created that is too big for the amount of free diskspace, I trim it down to the available free disk<br />space. Last but not least, Instead of assuming that there has to be free diskspace left after adding each primary partition, I check whether we need to creat<br />e any extra partitions at all. If not, then we don't need any free diskspace and the entire check is skipped.<br /><br />I attached the patch to this post too.<br /><br />I will once again report my findings to the debian-boot list and also to bugs.debian.org.<br /><br />Now that the partition scheme is OK, I want to ask the user for a hostname for the machine.<br />The debconf variable "netcfg/get_hostname" is what I'm looking for, but I can't seem to get debian-installer to ask me that question. Setting it to some valu<br />e works, as well as letting DHCP set it.<br />But debian-installer never asks the question and assumes the default hostname "debian" if no other is picked.<br />The netcfg udeb contains no .config file and the only real executable I can find in there is the program "/bin/netcfg" which is a binary. Patching the source<br /> is something I want to avoid.<br />The reason why the question is not asked is probably because the priority is too low (I'm using priority "critical" in preseed)<br /><br />I'm considering asking the question in some custom config script and maybe setting it myself. Before I can do that I need to know where the hostname is used <br />so that I can reverse whatever debian-installer does with the hostname it picks.<br />I've installed debian with the hostname and networkname "xyz123abc". Much to my surprise, this hostname is not used. Instead, the reverse DNS "dhcp-119" is u<br />sed (and I'm not even using DHCP, just the IP address)<br /><br />Anyway, grepping for "dhcp-119" in all files results in the following list:<br /><pre><br />/etc/hostname<br />/etc/hosts<br />/etc/motd<br />/etc/exim4/update-exim4.conf.conf<br />/etc/ssh/ssh_host_rsa_key.pub<br />/etc/ssh/ssh_host_dsa_key.pub<br />/etc/mailname<br />/var/lib/exim4/config.autogenerated<br />/var/cache/debconf/config.dat<br />/var/cache/debconf/config.dat-old<br />/var/log/exim4/mainlog<br />/var/log/syslog<br />/var/log/auth.log<br />/var/log/debian-installer/cdebconf/questions.dat<br />/var/log/daemon.log<br />/var/log/kern.log<br />/var/log/lpr.log<br />/var/log/debug<br />/var/log/messages<br />/var/spool/mail/mail<br />/var/mail/mail<br /></pre><br /><br />In /var/cache/debconf/config.dat (where the answers to the debconf questions are stored), I find that there is also a variable base-config/get-hostname (mind<br /> the "-" instead of "_")<br />This doesn't do the trick either... Debian insists on calling my machine "dhcp-119".<br /><br />The hostname seems to be set in the base-config udeb. There is also a baseconfig-udeb udeb, which appears to be the second stage installer.<br /><br />This code is probably the culprit (from base-config udeb /usr/lib/base-config/menu/hostname)<br /><pre><br />if [ -z "$currname" ] || [ "$currname" = localhost ]; then<br />        # Check IP addresses of interfaces, try to look up<br />        # using DNS, use that name as default hostname, and<br />        # ask medium priority question if there is a<br />        # default, and high priority question if the default<br />        # is empty.<br />        priority=high<br /><br />        # Make sure there is some good default.  Only change<br />        # the default value, to make it possible to override<br />        # this using the debconf database.<br />        db_set base-config/get-hostname $defaultname<br />        set_default_from_dns<br />else<br />        # Ask at medium priority so the menu item does something if<br />        # manaully selected.<br />        priority=medium<br />        db_set base-config/get-hostname $currname<br />fi<br /><br /></pre>
</div>


    </div>

  </body>
</html>
